name: Ultimate Builder (Auto-Fix + Deps + Keystone)

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  build_all:
    runs-on: macos-latest
    permissions:
      contents: write
      
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø¹Ù† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (ÙŠØ¹Ø§Ù„Ø¬ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª)
      # ------------------------------------------------------------------
      - name: 2. Smart Unzip & Locate
        run: |
          # ÙÙƒ Ø¶ØºØ· Ø£ÙŠ Ù…Ù„Ù zip
          find . -name "*.zip" -exec unzip -o -q {} \;
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù ÙƒÙˆØ¯ (.xm) Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
          SOURCE_FILE=$(find . -name "*.xm" | head -n 1)
          
          if [ -z "$SOURCE_FILE" ]; then
            echo "::error::Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ù„Ù ÙƒÙˆØ¯ (.xm)! ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª."
            exit 1
          fi
          
          # Ø­ÙØ¸ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
          PROJECT_DIR=$(dirname "$SOURCE_FILE")
          echo "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙÙŠ: $PROJECT_DIR"
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV

      # ------------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª (KittyMemory, fmt, Keystone)
      # ------------------------------------------------------------------
      - name: 3. Install All Dependencies
        run: |
          cd ${{ env.PROJECT_DIR }}
          mkdir -p deps
          
          echo "â¬‡ï¸ Downloading Dependencies..."
          rm -rf deps/KittyMemory deps/fmt deps/keystone
          
          # KittyMemory (Ù„Ù„Ø°Ø§ÙƒØ±Ø©)
          git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
          
          # fmt (Ù„Ù„Ù†ØµÙˆØµ)
          git clone --depth=1 https://github.com/fmtlib/fmt.git deps/fmt
          
          # Keystone (Ø§Ù„ØªÙŠ Ø³Ø£Ù„Øª Ø¹Ù†Ù‡Ø§ - Ù…Ø­Ø±Ùƒ Ø§Ù„Ø£Ø³Ù…Ø¨Ù„ÙŠ)
          # Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„ÙØ§Øª Ø§Ù„Ù‡ÙŠØ¯Ø± (Headers)
          git clone --depth=1 https://github.com/keystone-engine/keystone.git deps/keystone

      # ------------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø°Ø±ÙŠ - ÙƒØªØ§Ø¨Ø© Makefile Ø´Ø§Ù…Ù„ ÙˆØ¬Ø¯ÙŠØ¯
      # ------------------------------------------------------------------
      - name: 4. Generate Ultimate Makefile
        run: |
          cd ${{ env.PROJECT_DIR }}
          
          echo "â™»ï¸ Deleting old Makefile..."
          rm -f Makefile
          
          echo "ğŸ“ Writing NEW Makefile..."
          # Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ±Ø¨Ø· ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ù…Ø¹Ø§Ù‹ ÙˆÙŠØµØ­Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
          cat > Makefile <<EOF
          TARGET := iphone:clang:latest:14.0
          ARCHS = arm64
          include \$(THEOS)/makefiles/common.mk

          TWEAK_NAME = UEDumper

          # Ø¬Ù…Ø¹ ÙƒÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø³ÙˆØ±Ø³
          UEDumper_FILES = \$(wildcard *.xm) \$(wildcard *.mm) \$(wildcard *.cpp) \$(wildcard src/*.cpp) \$(wildcard src/*.mm)
          
          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¶Ù…ÙŠÙ† (Include Paths) Ù„ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
          # Ù„Ø§Ø­Ø¸ Ø£Ù†Ù†Ø§ Ø£Ø¶ÙÙ†Ø§ Keystone Ùˆ fmt Ùˆ KittyMemory
          UEDumper_CCFLAGS = -std=c++17 \
            -I"deps/KittyMemory" \
            -I"deps/fmt/include" \
            -I"deps/keystone/include" \
            -DFMT_HEADER_ONLY

          UEDumper_CFLAGS = -I"deps/KittyMemory" -I"deps/fmt/include" -I"deps/keystone/include"
          
          # ØªØ¬Ø§Ù‡Ù„ Ø¨Ø¹Ø¶ Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª Ø§Ù„Ù…Ø²Ø¹Ø¬Ø©
          UEDumper_CCFLAGS += -Wno-unused-variable -Wno-unused-function
          
          include \$(THEOS_MAKE_PATH)/tweak.mk
          EOF
          
          echo "âœ… Makefile created successfully."

      # ------------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø¥Ø¹Ø¯Ø§Ø¯ Theos
      # ------------------------------------------------------------------
      - name: 5. Setup Theos
        uses: actions/checkout@v4
        with:
          repository: theos/theos
          path: theos
          ref: master

      # ------------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ù‚Ù† (Dylib)
      # ------------------------------------------------------------------
      - name: 6. Build & Extract Dylib
        run: |
          export THEOS=$(pwd)/theos
          cd ${{ env.PROJECT_DIR }}
          
          echo "ğŸš€ Building Project..."
          make clean
          # Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ Ø³ØªÙƒÙˆÙ† Ù…ÙØµÙ„Ø©
          make package FINALPACKAGE=1 messages=yes
          
          # ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª
          mkdir -p ../FINAL_OUTPUT
          
          echo "ğŸ” Extracting Dylib (For Injection)..."
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù„Ù Dylib Ø§Ù„ØµØ§ÙÙŠ Ù…Ù† Ù‚Ù„Ø¨ Theos
          find .theos -name "*.dylib" -exec cp {} ../FINAL_OUTPUT/UEDumper_Injection.dylib \;
          
          # Ù†Ø³Ø® Ù…Ù„Ù DEB Ø£ÙŠØ¶Ø§Ù‹
          cp packages/*.deb ../FINAL_OUTPUT/ 2>/dev/null || true
          
          echo "âœ… Build Complete."
          ls -la ../FINAL_OUTPUT/

      # ------------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 6: Ø§Ù„Ø±ÙØ¹
      # ------------------------------------------------------------------
      - name: 7. Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_Final_Files
          path: FINAL_OUTPUT/*
