name: Auto Build UEDumper (No Jailbreak)

on:
  push:
    branches: ["**"]      # سيعمل تلقائياً عند أي تعديل أو رفع ملف
  workflow_dispatch:      # زر التشغيل اليدوي أيضاً

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. البحث عن الملف المضغوط وفك ضغطه أينما كان
      - name: Unzip & Find Source
        run: |
          # البحث عن أي ملف zip وفك ضغطه
          find . -name "*.zip" -exec unzip -o -q {} \;
          
          # البحث عن الكود الحقيقي (ملفات .xm) لتحديد مكان المشروع
          # هذا يتجاهل أسماء المجلدات الخاطئة
          SOURCE_FILE=$(find . -name "*.xm" | head -n 1)
          
          if [ -z "$SOURCE_FILE" ]; then
            echo "::error::لم يتم العثور على ملفات الكود (.xm) داخل الملف المضغوط!"
            exit 1
          fi
          
          # تحديد مجلد المشروع
          PROJECT_DIR=$(dirname "$SOURCE_FILE")
          echo "✅ تم العثور على المشروع في: $PROJECT_DIR"
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV

      # 2. تحميل المكتبات الضرورية بالقوة
      - name: Force Install Deps
        run: |
          cd ${{ env.PROJECT_DIR }}
          mkdir -p deps
          rm -rf deps/KittyMemory deps/fmt
          
          git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
          git clone --depth=1 https://github.com/fmtlib/fmt.git deps/fmt

      # 3. إنشاء ملف Makefile جديد (لتجاوز الأخطاء السابقة)
      - name: Generate Clean Makefile
        run: |
          cd ${{ env.PROJECT_DIR }}
          rm -f Makefile
          
          # إنشاء ملف بناء جديد ونظيف
          cat > Makefile <<EOF
          TARGET := iphone:clang:latest:14.0
          ARCHS = arm64
          include \$(THEOS)/makefiles/common.mk

          TWEAK_NAME = UEDumper
          
          # جمع كل الملفات البرمجية تلقائياً
          UEDumper_FILES = \$(wildcard *.xm) \$(wildcard *.mm) \$(wildcard *.cpp) \$(wildcard src/*.cpp) \$(wildcard src/*.mm)
          
          # إعدادات التضمين
          UEDumper_CCFLAGS = -std=c++17 -I"deps/KittyMemory" -I"deps/fmt/include" -DFMT_HEADER_ONLY
          UEDumper_CFLAGS = -I"deps/KittyMemory" -I"deps/fmt/include"
          
          include \$(THEOS_MAKE_PATH)/tweak.mk
          EOF

      # 4. إعداد بيئة Theos
      - name: Setup Theos
        uses: actions/checkout@v4
        with:
          repository: theos/theos
          path: theos
          ref: master

      # 5. البناء واستخراج ملفات الحقن
      - name: Build & Export
        run: |
          export THEOS=$(pwd)/theos
          cd ${{ env.PROJECT_DIR }}
          
          make clean
          make package FINALPACKAGE=1 messages=yes
          
          # تجهيز مجلد المخرجات
          mkdir -p ../output_final
          
          # نسخ ملف DEB
          cp packages/*.deb ../output_final/ 2>/dev/null || true
          
          # استخراج ملف Dylib (المهم للحقن بدون جلبريك)
          echo "Extracting Dylib..."
          find .theos -name "*.dylib" -exec cp {} ../output_final/UEDumper_Injection.dylib \;

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_Ready_Files
          path: output_final/*
