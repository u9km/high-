name: Build (Unzip + Auto Root + New Makefile)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 1) Unzip all zip(s) + print full tree
        shell: bash
        run: |
          set -euo pipefail
          rm -rf _extract
          mkdir -p _extract

          echo "ğŸ” ZIP files in repo:"
          ls -la *.zip 2>/dev/null || true

          # ÙÙƒ ÙƒÙ„ zip (Ù„Ùˆ ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ø£ÙƒØ«Ø±)
          shopt -s nullglob
          for z in *.zip; do
            echo "ğŸ“¦ Unzipping: $z"
            unzip -o -q "$z" -d _extract
          done

          echo "âœ… Full extracted tree (depth 6):"
          find _extract -maxdepth 6 -print

      - name: 2) Locate PROJECT_ROOT automatically
        shell: bash
        run: |
          set -euo pipefail

          # Ù†Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¬Ù„Ø¯ ÙÙŠÙ‡ src/Tweak.mm Ø£Ùˆ Tweak.xm Ø£Ùˆ Makefile Ø£Ùˆ control
          # (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù…Ø¬Ù„Ø¯ Tweak Ø¥Ù† ÙˆØ¬Ø¯)
          CANDIDATE="$(
            find _extract -type f \( -name "Tweak.mm" -o -name "Tweak.xm" -o -name "Tweak.m" -o -name "Makefile" -o -name "control" \) \
              | sed 's|/[^/]*$||' \
              | awk '
                  { print $0 }
                ' \
              | sort -u \
              | awk '
                  /\/Tweak(\/|$)/ { print; exit }
                  { last=$0 }
                  END { if (NR>0) print last }
                ' \
              | head -n 1
          )"

          if [ -z "${CANDIDATE:-}" ]; then
            echo "âŒ PROJECT_ROOT not found inside _extract"
            exit 1
          fi

          echo "âœ… PROJECT_ROOT=$CANDIDATE"
          echo "PROJECT_ROOT=$CANDIDATE" >> "$GITHUB_ENV"

      - name: 3) Prepare deps (KittyMemory) if missing + print include dirs
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          mkdir -p deps

          # Ø§Ø¨Ø­Ø« Ø¹Ù† KittyInclude.hpp Ø¯Ø§Ø®Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙ„Ù‡
          KITTY_HDR="$(find .. -type f -name "KittyInclude.hpp" | head -n 1 || true)"

          if [ -n "${KITTY_HDR:-}" ]; then
            echo "âœ… Found KittyInclude.hpp: $KITTY_HDR"
            # Ø®Ø° Ø¬Ø°Ø± KittyMemory (ØºØ§Ù„Ø¨Ø§Ù‹ .../KittyMemory/KittyMemory/KittyInclude.hpp)
            KITTY_DIR="$(dirname "$KITTY_HDR")"
            # Ù„Ùˆ Ø§Ù„Ù…Ø³Ø§Ø± ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ KittyMemory/KittyMemory Ø®Ù„Ù‘ Ø§Ù„Ø¬Ø°Ø± Ù‡Ùˆ Ø§Ù„Ø£ÙˆÙ„
            if [ "$(basename "$KITTY_DIR")" = "KittyMemory" ] && [ "$(basename "$(dirname "$KITTY_DIR")")" = "KittyMemory" ]; then
              KITTY_ROOT="$(dirname "$KITTY_DIR")"
            else
              KITTY_ROOT="$KITTY_DIR"
            fi

            rm -rf deps/KittyMemory
            mkdir -p deps/KittyMemory
            cp -R "$KITTY_ROOT/"* deps/KittyMemory/ || true
          else
            echo "âš ï¸ KittyInclude.hpp not found in zip. Cloning KittyMemory..."
            rm -rf deps/KittyMemory
            git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
          fi

          echo "ğŸ“Œ deps/KittyMemory tree (depth 4):"
          find deps/KittyMemory -maxdepth 4 -print || true

      - name: 4) Delete old Makefile + generate NEW Makefile safely (fix missing separator)
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          rm -f Makefile

          # Ù†Ø¬Ù…Ø¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ø³ÙˆØ±Ø³ ÙØ¹Ù„ÙŠØ§Ù‹ (ÙˆÙ†Ø³ØªØ«Ù†ÙŠ Ø£Ù…Ø«Ù„Ø© Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ Ø¯Ø§Ø®Ù„ KittyMemory Ù„ØªØ¬Ù†Ø¨ link.h ÙˆØºÙŠØ±Ù‡)
          python3 - <<'PY'
          import os, subprocess, shlex

          root = os.getcwd()

          def run(cmd):
            return subprocess.check_output(cmd, cwd=root, text=True).splitlines()

          # Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„ÙØ§Øª tweak/sources Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (src + Ø§Ù„Ø¬Ø°Ø±)
          files = []
          for pat in ["*.xm","*.mm","*.m","src/**/*.mm","src/**/*.m","src/**/*.cpp","src/**/*.cc","src/**/*.c","src/**/*.hpp","src/**/*.h"]:
            pass

          # Ø§Ø³ØªØ®Ø¯Ù… find Ù„Ø£Ù† glob ÙÙŠ Ø¨Ø§ÙŠØ«ÙˆÙ† Ù…Ø¹ ** ÙŠØ­ØªØ§Ø¬ Ø¶Ø¨Ø·
          find_cmd = [
            "bash","-lc",
            r"""
            set -e
            find . -type f \( \
              -name "*.xm" -o -name "*.mm" -o -name "*.m" -o -name "*.cpp" -o -name "*.cc" -o -name "*.c" \
            \) \
            | sed 's|^\./||' \
            | grep -v '^deps/KittyMemory/example' \
            | grep -v '^deps/KittyMemory/Example' \
            | grep -v '^deps/KittyMemory/Examples' \
            | grep -v '^deps/KittyMemory/Android' \
            | grep -v '^deps/KittyMemory/example-android' \
            | sort
            """
          ]
          all_src = run(find_cmd)

          # ÙÙ„ØªØ±: Ù„Ø§ ØªØ¯Ø®Ù„ Ù…Ù„ÙØ§Øª Ø¯Ø§Ø®Ù„ .theos Ø£Ùˆ packages Ø£Ùˆ build artifacts
          all_src = [f for f in all_src if not (f.startswith(".theos/") or f.startswith("packages/") or "/.theos/" in f)]

          # Ø¥Ø°Ø§ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯Ø§Øª Ø£Ø®Ø±Ù‰ØŒ Ø£Ù‡Ù… Ø´ÙŠØ¡ Ø¹Ù†Ø¯Ù†Ø§ Tweak.* Ùˆ src/*
          if not all_src:
            raise SystemExit("No source files found to include in Makefile.")

          # Ø§Ø³Ù… Ø§Ù„ØªÙˆÙŠÙƒ
          tweak_name = "UEDumper"

          makefile = f"""TARGET := iphone:clang:latest:14.0
ARCHS := arm64 arm64e
THEOS_PACKAGE_SCHEME := rootless

include $(THEOS)/makefiles/common.mk

TWEAK_NAME := {tweak_name}

# Auto-collected sources (existing only)
{tweak_name}_FILES := \\
"""
          for i, f in enumerate(all_src):
            sep = " \\\n" if i != len(all_src)-1 else "\n"
            makefile += f"\t{f}{sep}"

          makefile += f"""
{tweak_name}_FRAMEWORKS := UIKit Foundation Security
{tweak_name}_CFLAGS += -fobjc-arc -Wno-error -Wno-deprecated-declarations -Wno-unused-variable -Wno-unused-parameter
{tweak_name}_CCFLAGS += -std=c++17

# Includes (add more if your project needs)
{tweak_name}_CFLAGS += -I.
{tweak_name}_CFLAGS += -Isrc
{tweak_name}_CFLAGS += -Ideps/KittyMemory
{tweak_name}_CFLAGS += -Ideps/KittyMemory/KittyMemory

include $(THEOS_MAKE_PATH)/tweak.mk
"""
          # Ø§ÙƒØªØ¨ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù…Ø³Ø§ÙØ§Øª Ø¨Ø§Ø¯Ø¦Ø© ØªØ³Ø¨Ø¨ "missing separator"
          with open("Makefile","w",newline="\n") as fp:
            fp.write(makefile)

          print("âœ… Generated Makefile with", len(all_src), "source files")
          PY

          echo "ğŸ“„ Makefile preview (first 120 lines):"
          nl -ba Makefile | head -n 120

      - name: 5) Setup Theos + SDKs (fix 'sdks already exists')
        shell: bash
        run: |
          set -euo pipefail

          rm -rf "$HOME/theos"
          git clone --recursive --depth=1 https://github.com/theos/theos.git "$HOME/theos"

          echo "THEOS=$HOME/theos" >> "$GITHUB_ENV"
          echo "$HOME/theos/bin" >> "$GITHUB_PATH"

          # Ø­Ù„ Ø®Ø·Ø£: destination path .../theos/sdks already exists
          rm -rf "$HOME/theos/sdks"
          git clone --depth=1 https://github.com/theos/sdks.git "$HOME/theos/sdks"

          # Ø£Ø¯ÙˆØ§Øª Ù…Ø·Ù„ÙˆØ¨Ø©
          brew update
          brew install ldid xz || true

          echo "âœ… Theos installed at: $HOME/theos"
          ls -la "$HOME/theos/sdks" | head -n 50 || true

      - name: 6) Build (package)
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          echo "ğŸš€ Building in: $PWD"
          make clean || true
          make package FINALPACKAGE=1 messages=yes

      - name: 7) Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Build_Artifacts
          path: |
            ${{ env.PROJECT_ROOT }}/packages/*.deb
            ${{ env.PROJECT_ROOT }}/.theos/obj/**/*
