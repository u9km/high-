name: Final A-Z Build (Fix dm.pl & sdks)

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      # حل مشكلة dm.pl: تثبيت الأدوات الضرورية يدوياً
      - name: 2. Install System Tools (dpkg & ldid)
        run: |
          brew update
          brew install ldid dpkg make 

      # فك الضغط والبحث الذكي عن المشروع لتجنب خطأ "لم يتم العثور على ملفات"
      - name: 3. Smart Unzip & Locate
        run: |
          find . -name "*.zip" -exec unzip -o -q {} \;
          SOURCE_FILE=$(find . -type f \( -name "*.xm" -o -name "*.mm" -o -name "*.cpp" -o -name "*.c" \) | head -n 1)
          if [ -z "$SOURCE_FILE" ]; then
            echo "::error::لم يتم العثور على سورس كود!"
            exit 1
          fi
          PROJECT_DIR=$(dirname "$SOURCE_FILE")
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV
          echo "✅ Found project in: $PROJECT_DIR"

      # إعداد Theos مع حل مشكلة المجلد الموجود مسبقاً (SDKS)
      - name: 4. Setup Theos & SDKs
        run: |
          export THEOS=~/theos
          if [ ! -d "$THEOS" ]; then
            git clone --recursive https://github.com/theos/theos.git $THEOS
          fi
          
          # تحميل الـ SDKs فقط إذا كان المجلد فارغاً لتجنب خطأ Exit Code 128
          mkdir -p $THEOS/sdks
          if [ -z "$(ls -A $THEOS/sdks)" ]; then
            git clone --depth=1 https://github.com/theos/sdks.git $THEOS/sdks
          fi
          
          echo "THEOS=$THEOS" >> $GITHUB_ENV
          echo "$THEOS/bin" >> $GITHUB_PATH

      # تحميل المكتبات (KittyMemory, fmt)
      - name: 5. Install Dependencies
        run: |
          cd ${{ env.PROJECT_DIR }}
          mkdir -p deps
          git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
          git clone --depth=1 https://github.com/fmtlib/fmt.git deps/fmt

      # بناء ملف الـ Dylib المباشر (تجاوز خطأ التغليف كـ Deb)
      - name: 6. Build Dylib
        run: |
          export THEOS=~/theos
          cd ${{ env.PROJECT_DIR }}
          
          # إنشاء Makefile نظيف إذا لزم الأمر لضمان المسارات
          cat > Makefile <<EOF
          TARGET := iphone:clang:latest:14.0
          ARCHS = arm64
          include \$(THEOS)/makefiles/common.mk
          TWEAK_NAME = UEDumper
          UEDumper_FILES = \$(wildcard *.xm) \$(wildcard *.mm) \$(wildcard *.cpp) \$(wildcard src/*.cpp) \$(wildcard src/*.mm)
          UEDumper_CCFLAGS = -std=c++17 -I"deps/KittyMemory" -I"deps/fmt/include" -DFMT_HEADER_ONLY
          UEDumper_CFLAGS = -I"deps/KittyMemory" -I"deps/fmt/include"
          include \$(THEOS_MAKE_PATH)/tweak.mk
          EOF

          # تنفيذ البناء
          make FINALPACKAGE=1 messages=yes

      # استخراج الملفات النهائية للتحميل
      - name: 7. Extract & Upload
        run: |
          mkdir -p output
          # البحث عن ملف الـ dylib الناتج ونسخه
          find . -name "*.dylib" -exec cp {} output/UEDumper_Ready.dylib \;
          # البحث عن ملف الـ deb إذا نجح إنتاجه
          find packages -name "*.deb" -exec cp {} output/ 2>/dev/null || true
          
      - name: 8. Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_NonJailbreak_Build
          path: output/*
