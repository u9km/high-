name: Ultimate Theos Build (Auto Fix + Auto Makefile)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 1) Unzip ALL zip files (recursive) + show full tree
        shell: bash
        run: |
          set -euo pipefail
          rm -rf _extract
          mkdir -p _extract

          echo "ğŸ” Searching for zip files..."
          shopt -s nullglob
          ZIPS=( *.zip )
          if [ ${#ZIPS[@]} -eq 0 ]; then
            echo "âŒ No .zip found in repo root."
            ls -la
            exit 1
          fi

          for z in "${ZIPS[@]}"; do
            echo "ğŸ“¦ Unzipping: $z"
            unzip -o -q "$z" -d _extract
          done

          echo "âœ… Top tree:"
          find _extract -maxdepth 4 -print

      - name: 2) Locate PROJECT_ROOT (deep search) + export env
        shell: bash
        run: |
          set -euo pipefail

          # Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØªÙˆÙŠÙƒ
          MAIN_SRC="$(find _extract -type f \( -name 'Tweak.mm' -o -name 'Tweak.xm' -o -name 'Tweak.m' \) | head -n 1 || true)"

          if [ -z "${MAIN_SRC:-}" ]; then
            # fallback: Ø£ÙŠ Makefile Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ zip
            MK="$(find _extract -type f -name 'Makefile' | head -n 1 || true)"
            if [ -z "${MK:-}" ]; then
              echo "âŒ Could not find Tweak.mm/xm/m or Makefile inside extracted content."
              exit 1
            fi
            PROJECT_ROOT="$(dirname "$MK")"
          else
            PROJECT_ROOT="$(dirname "$MAIN_SRC")"
            # Ø¥Ø°Ø§ Ø¯Ø§Ø®Ù„ src Ù†Ø·Ù„Ø¹ Ù„ÙÙˆÙ‚
            if [ "$(basename "$PROJECT_ROOT")" = "src" ]; then
              PROJECT_ROOT="$(dirname "$PROJECT_ROOT")"
            fi
          fi

          # ØªÙ†Ø¸ÙŠÙ: Ø¥Ø°Ø§ ØµØ§Ø± Ø¯Ø§Ø®Ù„ iOS_UEDumper-main/Tweak Ù†Ø«Ø¨Øª Ù‡Ù†Ø§Ùƒ
          echo "âœ… PROJECT_ROOT=$PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> "$GITHUB_ENV"

          echo "ğŸ“Œ PROJECT_ROOT tree:"
          find "$PROJECT_ROOT" -maxdepth 4 -print

      - name: 3) Setup deps (KittyMemory + SSZipArchive) + fix include paths
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"
          mkdir -p deps

          echo "ğŸ”§ Ensuring KittyMemory..."
          rm -rf deps/KittyMemory
          git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory

          # ØªØ£ÙƒÙŠØ¯ ÙˆØ¬ÙˆØ¯ KittyInclude.hpp ÙˆØ¥Ø¸Ù‡Ø§Ø± Ù…ÙƒØ§Ù†Ù‡
          KITTY_HDR="$(find deps/KittyMemory -type f -name 'KittyInclude.hpp' | head -n 1 || true)"
          if [ -z "${KITTY_HDR:-}" ]; then
            echo "âŒ KittyInclude.hpp not found even after clone."
            find deps/KittyMemory -maxdepth 4 -print
            exit 1
          fi
          echo "âœ… Found KittyInclude.hpp at: $KITTY_HDR"

          echo "ğŸ”§ Ensuring SSZipArchive..."
          rm -rf deps/SSZipArchive
          git clone --depth=1 https://github.com/ZipArchive/ZipArchive.git deps/SSZipArchive

          echo "âœ… deps tree:"
          find deps -maxdepth 4 -print

      - name: 4) Auto-patch SSZipArchive imports (ZipArchive.h -> SSZipArchive.h)
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          echo "ğŸ” Searching for old import: <SSZipArchive/ZipArchive.h>"
          # Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ØªØ³ØªØ®Ø¯Ù… ZipArchive.h ØºÙ„Ø·
          MATCHES="$(grep -R --line-number --no-messages 'SSZipArchive/ZipArchive.h' . || true)"
          if [ -n "${MATCHES:-}" ]; then
            echo "âœ… Found matches:"
            echo "$MATCHES"
            echo "ğŸ©¹ Patching..."
            # macOS sed ÙŠØ­ØªØ§Ø¬ backup extension
            find . -type f \( -name '*.m' -o -name '*.mm' -o -name '*.xm' -o -name '*.hpp' -o -name '*.h' -o -name '*.cpp' \) \
              -print0 | xargs -0 sed -i '' 's#<SSZipArchive/ZipArchive.h>#<SSZipArchive/SSZipArchive.h>#g'
          else
            echo "â„¹ï¸ No old imports found. Skipping."
          fi

          echo "ğŸ” Quick check (SSZipArchive headers used):"
          grep -R --line-number --no-messages 'SSZipArchive/' . || true

      - name: 5) Delete old Makefile + Generate NEW smart Makefile (include KittyMemory + SSZipArchive + fmt)
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          echo "ğŸ—‘ï¸ Removing old Makefile if exists..."
          rm -f Makefile

          echo "ğŸ§  Collecting source files (deep) ..."
          # Ù†Ø¬Ù…Ø¹ ÙƒÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙØ¹Ù„Ø§Ù‹
          # (Ù†Ø³ØªØ«Ù†ÙŠ .theos Ùˆ packages Ùˆ Ø£ÙŠ build junk)
          SRC_LIST_FILE="/tmp/sources.txt"
          find . \
            -type f \
            \( -name '*.xm' -o -name '*.mm' -o -name '*.m' -o -name '*.cpp' -o -name '*.c' \) \
            ! -path './.theos/*' \
            ! -path './packages/*' \
            ! -path './_*/**' \
            -print | sed 's|^\./||' | sort > "$SRC_LIST_FILE"

          if [ ! -s "$SRC_LIST_FILE" ]; then
            echo "âŒ No source files found to build."
            find . -maxdepth 5 -print
            exit 1
          fi

          echo "âœ… Source files detected:"
          head -n 200 "$SRC_LIST_FILE"

          echo "ğŸ†• Writing new Makefile..."
          {
            echo 'TARGET := iphone:clang:latest:14.0'
            echo 'ARCHS = arm64 arm64e'
            echo 'THEOS_PACKAGE_SCHEME = rootless'
            echo ''
            echo 'include $(THEOS)/makefiles/common.mk'
            echo ''
            echo 'TWEAK_NAME = UEDumper'
            echo ''
            echo '# ---- Auto generated file list (existing only) ----'
            echo 'UEDumper_FILES = \'
            # Ù†Ø­ÙˆÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¥Ù„Ù‰ Ø£Ø³Ø·Ø± Ø¨Ù€Ù€ \ Ø­ØªÙ‰ ÙŠÙ‚Ø¨Ù„Ù‡Ø§ make
            awk '{printf "  %s \\\n", $0}' "$SRC_LIST_FILE"
            echo ''
            echo '# ---- Frameworks ----'
            echo 'UEDumper_FRAMEWORKS = UIKit Foundation Security'
            echo ''
            echo '# ---- Includes (KittyMemory + SSZipArchive + fmt) ----'
            echo '# KittyMemory: Ø§Ù„Ù‡ÙŠØ¯Ø± ØºØ§Ù„Ø¨Ø§Ù‹ Ø¯Ø§Ø®Ù„ KittyMemory/KittyInclude.hpp'
            echo '# SSZipArchive: Ù‡ÙŠØ¯Ø± SSZipArchive.h Ø¯Ø§Ø®Ù„ SSZipArchive/'
            echo '# fmt: Ù…Ù† Homebrew'
            echo 'UEDumper_CFLAGS  += -fobjc-arc -Wno-error -Wno-deprecated-declarations -Wno-unused-variable'
            echo 'UEDumper_CCFLAGS += -std=c++17 -Wno-error'
            echo ''
            echo '# Include dirs'
            echo 'UEDumper_CFLAGS  += -I$(THEOS_PROJECT_DIR)'
            echo 'UEDumper_CFLAGS  += -I$(THEOS_PROJECT_DIR)/src -I$(THEOS_PROJECT_DIR)/include'
            echo 'UEDumper_CFLAGS  += -I$(THEOS_PROJECT_DIR)/deps/KittyMemory -I$(THEOS_PROJECT_DIR)/deps/KittyMemory/KittyMemory'
            echo 'UEDumper_CFLAGS  += -I$(THEOS_PROJECT_DIR)/deps/SSZipArchive -I$(THEOS_PROJECT_DIR)/deps/SSZipArchive/SSZipArchive'
            echo 'UEDumper_CFLAGS  += -I/opt/homebrew/opt/fmt/include -I/usr/local/opt/fmt/include'
            echo ''
            echo '# Link fmt (if used by code)'
            echo 'UEDumper_LDFLAGS += -L/opt/homebrew/opt/fmt/lib -L/usr/local/opt/fmt/lib -lfmt'
            echo ''
            echo 'include $(THEOS_MAKE_PATH)/tweak.mk'
          } > Makefile

          echo "âœ… Makefile created:"
          sed -n '1,220p' Makefile

      - name: 6) Setup Theos (clean) + FIX sdks conflict + install brew deps
        shell: bash
        run: |
          set -euo pipefail

          echo "ğŸ§¹ Cleaning old theos..."
          rm -rf "$HOME/theos"

          echo "â¬‡ï¸ Cloning Theos..."
          git clone --recursive --depth=1 https://github.com/theos/theos.git "$HOME/theos"
          echo "THEOS=$HOME/theos" >> "$GITHUB_ENV"
          echo "$HOME/theos/bin" >> "$GITHUB_PATH"

          echo "â¬‡ï¸ Installing SDKs clean (avoid already exists)..."
          rm -rf "$HOME/theos/sdks"
          git clone --depth=1 https://github.com/theos/sdks.git "$HOME/theos/sdks"

          # ØªØ®ÙÙŠÙ
          rm -rf "$HOME/theos/sdks/iPhoneOS"{9..13}.sdk || true

          echo "ğŸº Installing brew deps (ldid, xz, fmt)..."
          brew update
          brew install ldid xz fmt

          echo "âœ… Theos ready:"
          ls -la "$HOME/theos"
          ls -la "$HOME/theos/sdks" | head -n 50

      - name: 7) Build (auto include paths)
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          echo "ğŸš€ Building from: $PWD"
          make clean || true

          # ØªÙ…Ø±ÙŠØ± Ù…Ø³Ø§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ§Ù‹ (Ù„Ùˆ ÙƒÙˆØ¯Ùƒ ÙŠØªØ·Ù„Ø¨)
          EXTRA_INC="-I$PWD/deps/KittyMemory -I$PWD/deps/KittyMemory/KittyMemory -I$PWD/deps/SSZipArchive -I$PWD/deps/SSZipArchive/SSZipArchive -I/opt/homebrew/opt/fmt/include -I/usr/local/opt/fmt/include"
          EXTRA_LIB="-L/opt/homebrew/opt/fmt/lib -L/usr/local/opt/fmt/lib -lfmt"

          make package FINALPACKAGE=1 messages=yes THEOS_PACKAGE_SCHEME=rootless \
            ADDITIONAL_CFLAGS="$EXTRA_INC" \
            ADDITIONAL_CCFLAGS="$EXTRA_INC -std=c++17" \
            ADDITIONAL_LDFLAGS="$EXTRA_LIB"

      - name: 8) Upload DEB + dylib (if exists)
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_Build_Output
          path: |
            ${{ env.PROJECT_ROOT }}/packages/*.deb
            ${{ env.PROJECT_ROOT }}/.theos/obj/**/UEDumper.dylib
            ${{ env.PROJECT_ROOT }}/.theos/obj/**/UEDumper.*
