name: iOS UEDumper Build (SAFE)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --------------------------------------------------
      # 1) Unzip project
      # --------------------------------------------------
      - name: Unzip project zip
        shell: bash
        run: |
          set -e
          rm -rf _extract
          mkdir _extract
          unzip -o *.zip -d _extract
          echo "Extracted tree:"
          find _extract -maxdepth 3 -type d

      # --------------------------------------------------
      # 2) Locate PROJECT_ROOT
      # --------------------------------------------------
      - name: Locate PROJECT_ROOT
        shell: bash
        run: |
          set -e
          ROOT=$(find _extract -name Makefile -o -name Tweak.mm -o -name Tweak.xm | head -n 1)
          if [ -z "$ROOT" ]; then
            echo "âŒ Project root not found"
            exit 1
          fi
          PROJECT_ROOT=$(dirname "$ROOT")
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> $GITHUB_ENV
          echo "PROJECT_ROOT = $PROJECT_ROOT"

      # --------------------------------------------------
      # 3) Setup Theos
      # --------------------------------------------------
      name: Setup Theos (clean + sdks fix)
        shell: bash
        run: |
          set -e

          echo "ðŸ§¹ Cleaning old Theos..."
          rm -rf "$HOME/theos"

          echo "â¬‡ï¸ Cloning Theos..."
          git clone --recursive https://github.com/theos/theos.git "$HOME/theos"

          echo "â¬‡ï¸ Cloning SDKs..."
          rm -rf "$HOME/theos/sdks"
          git clone https://github.com/theos/sdks.git "$HOME/theos/sdks"

          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "$HOME/theos/bin" >> $GITHUB_PATH

          brew install ldid

      # --------------------------------------------------
      # 4) Delete Makefile + Generate SAFE Makefile
      # --------------------------------------------------
      - name: Generate Makefile
        shell: bash
        run: |
          set -e
          cd "$PROJECT_ROOT"
          rm -f Makefile

          echo "Generating Makefile..."

          echo "TARGET := iphone:clang:latest:14.0" > Makefile
          echo "ARCHS := arm64 arm64e" >> Makefile
          echo "THEOS_PACKAGE_SCHEME := rootless" >> Makefile
          echo "" >> Makefile
          echo "include \$(THEOS)/makefiles/common.mk" >> Makefile
          echo "" >> Makefile
          echo "TWEAK_NAME := UEDumper" >> Makefile
          echo "" >> Makefile
          echo "UEDumper_FILES := \\" >> Makefile

          find . -type f \
            \( -name '*.xm' -o -name '*.mm' -o -name '*.m' -o -name '*.cpp' \) \
            -not -path './.theos/*' \
            | sed 's|^\./||' \
            | sort \
            | while read f; do
                echo "  $f \\" >> Makefile
              done

          echo "" >> Makefile
          echo "UEDumper_FRAMEWORKS := UIKit Foundation Security" >> Makefile
          echo "UEDumper_CFLAGS += -fobjc-arc -Wno-error" >> Makefile
          echo "UEDumper_CCFLAGS += -std=c++17" >> Makefile
          echo "" >> Makefile
          echo "include \$(THEOS_MAKE_PATH)/tweak.mk" >> Makefile

          echo "Makefile generated:"
          sed -n '1,120p' Makefile

      # --------------------------------------------------
      # 5) Build
      # --------------------------------------------------
      - name: Build
        shell: bash
        run: |
          set -e
          cd "$PROJECT_ROOT"
          make clean || true
          make package

      # --------------------------------------------------
      # 6) Upload result
      # --------------------------------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper-output
          path: |
            ${{ env.PROJECT_ROOT }}/packages/*.deb
            ${{ env.PROJECT_ROOT }}/.theos/obj/**/*.dylib
