name: Ultimate Theos Build (Zip Project, Auto-Fix)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # 1) Extract ALL zip files (or single zip) + show FULL paths
      # ------------------------------------------------------------
      - name: 1) Unzip zips + print full tree
        shell: bash
        run: |
          set -euo pipefail

          rm -rf _extract
          mkdir -p _extract

          echo "ðŸ”Ž Searching for zip files in repo root..."
          ls -la

          ZIP_COUNT=$(find . -maxdepth 1 -type f -name "*.zip" | wc -l | tr -d ' ')
          if [ "$ZIP_COUNT" = "0" ]; then
            echo "âŒ No .zip found in repo root."
            exit 1
          fi

          echo "ðŸ“¦ Extracting zip(s) into _extract ..."
          find . -maxdepth 1 -type f -name "*.zip" -print -exec unzip -o -q {} -d _extract \;

          echo "âœ… FULL extracted tree (files + dirs) with absolute paths:"
          pwd
          find "$PWD/_extract" -print

      # ------------------------------------------------------------
      # 2) Locate PROJECT_ROOT (Tweak folder) by searching for control/Makefile/src/Tweak.mm
      # ------------------------------------------------------------
      - name: 2) Locate PROJECT_ROOT (Tweak folder)
        shell: bash
        run: |
          set -euo pipefail

          # Prefer: folder that contains "control" AND "src/Tweak.mm"
          CAND1=$(find _extract -type f -name "control" -path "*/Tweak/control" | head -n 1 || true)
          if [ -n "${CAND1:-}" ]; then
            PROJECT_ROOT=$(dirname "$CAND1")
          else
            # fallback: find src/Tweak.mm then go up to Tweak/
            SRC=$(find _extract -type f \( -name "Tweak.mm" -o -name "Tweak.xm" \) | head -n 1 || true)
            if [ -z "${SRC:-}" ]; then
              echo "âŒ Could not find control or Tweak.mm Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª."
              exit 1
            fi
            # if it's _extract/.../Tweak/src/Tweak.mm => project root = .../Tweak
            PROJECT_ROOT=$(cd "$(dirname "$SRC")/.." && pwd)
          fi

          echo "âœ… PROJECT_ROOT=$PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> "$GITHUB_ENV"

          echo "ðŸ“ PROJECT_ROOT tree:"
          find "$PROJECT_ROOT" -maxdepth 3 -print

      # ------------------------------------------------------------
      # 3) Ensure deps exist: KittyMemory (clone if missing) + verify SSZipArchive + fmt
      # ------------------------------------------------------------
      - name: 3) Fix deps (KittyMemory/SSZipArchive/fmt) + print exact include dirs
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          mkdir -p deps

          # --- KittyMemory: your zip ØºØ§Ù„Ø¨Ø§Ù‹ ÙŠØ­ØªÙˆÙŠ folder ÙØ§Ø¶ÙŠ ÙÙ‚Ø· ---
          KITTY_HDR=$(find "$PWD/deps" -type f -name "KittyInclude.hpp" 2>/dev/null | head -n 1 || true)
          if [ -z "${KITTY_HDR:-}" ]; then
            echo "âš ï¸ KittyInclude.hpp not found -> cloning KittyMemory..."
            rm -rf deps/KittyMemory
            git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
          fi

          KITTY_HDR=$(find "$PWD/deps/KittyMemory" -type f -name "KittyInclude.hpp" | head -n 1 || true)
          if [ -z "${KITTY_HDR:-}" ]; then
            echo "âŒ KittyMemory clone failed or KittyInclude.hpp not found."
            exit 1
          fi

          # include dir = folder that contains KittyInclude.hpp
          KITTY_INC_DIR=$(cd "$(dirname "$KITTY_HDR")" && pwd)
          echo "âœ… KittyInclude.hpp = $KITTY_HDR"
          echo "âœ… KITTY_INC_DIR  = $KITTY_INC_DIR"
          echo "KITTY_INC_DIR=$KITTY_INC_DIR" >> "$GITHUB_ENV"

          # --- SSZipArchive Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ zip Ø¹Ù†Ø¯Ùƒ ÙÙŠ /deps/SSZipArchive ---
          if [ ! -f "deps/SSZipArchive/ZipArchive.h" ] && [ ! -f "deps/SSZipArchive/SSZipArchive.h" ]; then
            echo "âŒ SSZipArchive not found in deps/SSZipArchive"
            echo "   Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ zip Ø£Ùˆ ØªØ¶ÙŠÙÙ‡."
            exit 1
          fi

          # fmt (Ø§Ù†Øª Ø¹Ù†Ø¯Ùƒ deps/fmt)
          if [ ! -f "deps/fmt/format.h" ] && [ ! -f "deps/fmt/format.cc" ]; then
            echo "âš ï¸ fmt not found in deps/fmt (will continue Ù„ÙƒÙ† Ù‚Ø¯ ÙŠÙØ´Ù„ Ø§Ø°Ø§ Ù…Ø´Ø±ÙˆØ¹Ùƒ ÙŠØ³ØªØ®Ø¯Ù… fmt)"
          fi

          echo "âœ… deps tree:"
          find "$PWD/deps" -maxdepth 4 -print

      # ------------------------------------------------------------
      # 4) Delete Makefile and generate a CLEAN one (NO wildcards into KittyMemory examples!)
      # ------------------------------------------------------------
      - name: 4) Delete old Makefile + generate new smart Makefile
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          echo "ðŸ—‘ï¸ Removing old Makefile..."
          rm -f Makefile

          echo "ðŸ§  Generating new Makefile (only project src + SSZipArchive + fmt) ..."
          cat > Makefile <<'EOF'
          TARGET := iphone:clang:latest:14.0
          ARCHS := arm64 arm64e
          THEOS_PACKAGE_SCHEME := rootless

          include $(THEOS)/makefiles/common.mk

          TWEAK_NAME := UEDumper

          # âœ… ONLY include tweak sources (avoid accidental deps examples like KittyMemory/example-android)
          UEDumper_FILES := \
            $(wildcard src/*.mm) \
            $(wildcard src/*.xm) \
            $(wildcard src/*.m)  \
            $(wildcard src/*.cpp) \
            $(wildcard src/UE/*.cpp) \
            $(wildcard src/UE/*.mm) \
            $(wildcard src/UE/*/*.cpp) \
            $(wildcard src/UE/*/*.mm)

          # âœ… SSZipArchive sources (so class SSZipArchive Ù…ÙˆØ¬ÙˆØ¯)
          UEDumper_FILES += \
            deps/SSZipArchive/SSZipArchive.m \
            deps/SSZipArchive/minizip/mz_compat.c \
            deps/SSZipArchive/minizip/mz_crypt.c \
            deps/SSZipArchive/minizip/mz_crypt_apple.c \
            deps/SSZipArchive/minizip/mz_os.c \
            deps/SSZipArchive/minizip/mz_strm.c \
            deps/SSZipArchive/minizip/mz_strm_buf.c \
            deps/SSZipArchive/minizip/mz_strm_mem.c \
            deps/SSZipArchive/minizip/mz_strm_os.c \
            deps/SSZipArchive/minizip/mz_strm_split.c \
            deps/SSZipArchive/minizip/mz_zip.c \
            deps/SSZipArchive/minizip/mz_zip_rw.c

          # âœ… fmt (Ø§Ø°Ø§ Ù…Ø´Ø±ÙˆØ¹Ùƒ ÙŠØ³ØªØ®Ø¯Ù… fmt::)
          # format.cc ÙŠÙˆÙØ± implementation Ù„Ù€ fmt (Ø®ØµÙˆØµØ§Ù‹ format.h)
          ifneq ("$(wildcard deps/fmt/format.cc)","")
            UEDumper_FILES += deps/fmt/format.cc
          endif

          UEDumper_FRAMEWORKS := UIKit Foundation Security
          UEDumper_LIBRARIES  := z iconv

          # C/ObjC
          UEDumper_CFLAGS   += -fobjc-arc -Wno-error -Wno-deprecated-declarations -Wno-unused-variable -Wno-unused-parameter
          # C++
          UEDumper_CCFLAGS  += -std=c++17 -Wno-error

          # include paths (Kitty / SSZipArchive / fmt / json / hash)
          UEDumper_CFLAGS  += -I. -Isrc -Isrc/UE -Ideps/SSZipArchive -Ideps/SSZipArchive/minizip -Ideps/fmt -Ideps/nlohmann -Ideps/hash
          UEDumper_CCFLAGS += -I. -Isrc -Isrc/UE -Ideps/SSZipArchive -Ideps/SSZipArchive/minizip -Ideps/fmt -Ideps/nlohmann -Ideps/hash

          include $(THEOS_MAKE_PATH)/tweak.mk
          EOF

          echo "âœ… New Makefile:"
          sed -n '1,200p' Makefile

      # ------------------------------------------------------------
      # 5) Setup Theos (clean) + fix sdks conflict (delete before clone)
      # ------------------------------------------------------------
      - name: 5) Setup Theos (clean) + SDKs
        shell: bash
        run: |
          set -euo pipefail

          rm -rf "$HOME/theos"
          git clone --recursive --depth=1 https://github.com/theos/theos.git "$HOME/theos"

          echo "THEOS=$HOME/theos" >> "$GITHUB_ENV"
          echo "$HOME/theos/bin" >> "$GITHUB_PATH"

          # Important: remove sdks dir before cloning to avoid "already exists"
          rm -rf "$HOME/theos/sdks"
          git clone --depth=1 https://github.com/theos/sdks.git "$HOME/theos/sdks"

          # speed up
          rm -rf "$HOME/theos/sdks/iPhoneOS"{9..13}".sdk" || true

          brew update
          brew install ldid xz || true

          echo "âœ… Theos ready:"
          ls -la "$HOME/theos" || true
          ls -la "$HOME/theos/sdks" | head -n 50 || true

      # ------------------------------------------------------------
      # 6) Build (force Kitty include dir in flags) + show paths
      # ------------------------------------------------------------
      - name: 6) Build package (force include dirs)
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          echo "ðŸ“Œ Using:"
          echo "PROJECT_ROOT = $PROJECT_ROOT"
          echo "KITTY_INC_DIR = $KITTY_INC_DIR"

          # Force Kitty include path (because your code uses <KittyInclude.hpp>)
          export CFLAGS="$CFLAGS -I$KITTY_INC_DIR"
          export CXXFLAGS="$CXXFLAGS -I$KITTY_INC_DIR"
          export CPPFLAGS="$CPPFLAGS -I$KITTY_INC_DIR"

          make clean || true
          make package FINALPACKAGE=1 messages=yes THEOS_PACKAGE_SCHEME=rootless

          echo "âœ… Build outputs:"
          find "$PROJECT_ROOT" -maxdepth 4 -type f \( -name "*.deb" -o -name "*.dylib" \) -print || true

      # ------------------------------------------------------------
      # 7) Upload artifacts (deb + dylib if exists)
      # ------------------------------------------------------------
      - name: 7) Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_build_outputs
          path: |
            ${{ env.PROJECT_ROOT }}/packages/*.deb
            ${{ env.PROJECT_ROOT }}/.theos/obj/**/*.dylib
            ${{ env.PROJECT_ROOT }}/.theos/obj/**/*.dylib.*
