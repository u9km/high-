name: Ultimate Builder (Fix dm.pl Error)

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  build_fix_final:
    runs-on: macos-latest
    permissions:
      contents: write
      
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------------
      # الخطوة 1: البحث الذكي (معدلة لتبحث عن كل أنواع الملفات)
      # ------------------------------------------------------------------
      - name: 2. Smart Unzip & Locate
        run: |
          find . -name "*.zip" -exec unzip -o -q {} \;
          
          # البحث عن أي ملف كود (.xm أو .cpp أو .mm)
          SOURCE_FILE=$(find . -type f \( -name "*.xm" -o -name "*.mm" -o -name "*.cpp" -o -name "*.c" \) | head -n 1)
          
          if [ -z "$SOURCE_FILE" ]; then
            echo "::error::لم يتم العثور على سورس كود!"
            exit 1
          fi
          
          PROJECT_DIR=$(dirname "$SOURCE_FILE")
          echo "✅ Project found in: $PROJECT_DIR"
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV

      # ------------------------------------------------------------------
      # الخطوة 2: تثبيت الأدوات الناقصة (dpkg + ldid) - هذا هو حل مشكلتك
      # ------------------------------------------------------------------
      - name: 3. Install System Tools
        run: |
          brew update
          # تثبيت dpkg هو الحل لرسالة "requires dm.pl"
          brew install ldid dpkg make

      # ------------------------------------------------------------------
      # الخطوة 3: تحميل مكتبات المشروع
      # ------------------------------------------------------------------
      - name: 4. Install Project Deps
        run: |
          cd ${{ env.PROJECT_DIR }}
          mkdir -p deps
          rm -rf deps/KittyMemory deps/fmt deps/keystone
          
          git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
          git clone --depth=1 https://github.com/fmtlib/fmt.git deps/fmt
          git clone --depth=1 https://github.com/keystone-engine/keystone.git deps/keystone

      # ------------------------------------------------------------------
      # الخطوة 4: إنشاء ملف Makefile + ملف Control (لضمان نجاح البناء)
      # ------------------------------------------------------------------
      - name: 5. Generate Config Files
        run: |
          cd ${{ env.PROJECT_DIR }}
          
          # 1. إنشاء Makefile
          rm -f Makefile
          cat > Makefile <<EOF
          TARGET := iphone:clang:latest:14.0
          ARCHS = arm64
          include \$(THEOS)/makefiles/common.mk

          TWEAK_NAME = UEDumper
          UEDumper_FILES = \$(wildcard *.xm) \$(wildcard *.mm) \$(wildcard *.cpp) \$(wildcard src/*.cpp) \$(wildcard src/*.mm) \$(wildcard src/*.c)
          UEDumper_CCFLAGS = -std=c++17 -I"deps/KittyMemory" -I"deps/fmt/include" -I"deps/keystone/include" -DFMT_HEADER_ONLY -Wno-unused-variable
          UEDumper_CFLAGS = -I"deps/KittyMemory" -I"deps/fmt/include" -I"deps/keystone/include"
          
          include \$(THEOS_MAKE_PATH)/tweak.mk
          EOF
          
          # 2. إنشاء ملف Control (مهم جداً لتفادي الأخطاء)
          if [ ! -f "control" ]; then
            echo "⚠️ Creating missing control file..."
            cat > control <<EOF
          Package: com.uedumper.ios
          Name: UEDumper
          Version: 1.0
          Architecture: iphoneos-arm
          Description: iOS Cheat
          Maintainer: You
          Author: You
          Section: Tweaks
          EOF
          fi

      # ------------------------------------------------------------------
      # الخطوة 5: إعداد Theos
      # ------------------------------------------------------------------
      - name: 6. Setup Theos
        uses: actions/checkout@v4
        with:
          repository: theos/theos
          path: theos
          ref: master

      # ------------------------------------------------------------------
      # الخطوة 6: البناء (الآن ستعمل 100%)
      # ------------------------------------------------------------------
      - name: 7. Run Build
        run: |
          export THEOS=$(pwd)/theos
          cd ${{ env.PROJECT_DIR }}
          
          make clean
          # الآن dpkg موجود والـ control موجود، فالبناء سينجح
          make package FINALPACKAGE=1 messages=yes
          
          mkdir -p ../FINAL
          find .theos -name "*.dylib" -exec cp {} ../FINAL/UEDumper_Injection.dylib \;
          cp packages/*.deb ../FINAL/ 2>/dev/null || true

      - name: 8. Upload
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_Success
          path: FINAL/*
