name: Build Auto Zip Project

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Unzip all zip files
        run: |
          set -e
          rm -rf _extract
          mkdir _extract
          for z in *.zip; do
            unzip -o "$z" -d _extract
          done
          echo "===== TREE ====="
          find _extract -maxdepth 6

      - name: Create helper script
        run: |
          cat <<'EOF' > locate_project.sh
          #!/usr/bin/env bash
          set -e

          CANDIDATE=$(find _extract -type f \
            \( -name "Tweak.mm" -o -name "Tweak.xm" -o -name "Makefile" \) \
            | head -n 1)

          if [ -z "$CANDIDATE" ]; then
            echo "âŒ Project root not found"
            exit 1
          fi

          PROJECT_ROOT=$(dirname "$CANDIDATE")
          echo "PROJECT_ROOT=$PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> $GITHUB_ENV
          EOF

          chmod +x locate_project.sh

      - name: Locate PROJECT_ROOT
        run: ./locate_project.sh

      - name: Generate clean Makefile
        run: |
          cd "$PROJECT_ROOT"
          rm -f Makefile

          cat <<'EOF' > Makefile
          TARGET := iphone:clang:latest:14.0
          ARCHS := arm64 arm64e

          include $(THEOS)/makefiles/common.mk

          TWEAK_NAME = UEDumper

          UEDumper_FILES = $(shell find . -type f \( -name "*.mm" -o -name "*.xm" -o -name "*.m" -o -name "*.cpp" \))

          UEDumper_CFLAGS = -fobjc-arc
          UEDumper_CCFLAGS = -std=c++17
          UEDumper_FRAMEWORKS = UIKit Foundation

          include $(THEOS_MAKE_PATH)/tweak.mk
          EOF

      - name: Install Theos
        run: |
          rm -rf $HOME/theos
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "$HOME/theos/bin" >> $GITHUB_PATH

          rm -rf $HOME/theos/sdks
          git clone https://github.com/theos/sdks.git $HOME/theos/sdks

          brew install ldid || true

      - name: Build
        run: |
          cd "$PROJECT_ROOT"
          make clean || true
          make package

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: output
          path: |
            ${{ env.PROJECT_ROOT }}/packages/*.deb
