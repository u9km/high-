name: Build iOS UEDumper (Clean)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Unzip project
        shell: bash
        run: |
          set -e
          rm -rf _extract
          mkdir _extract
          unzip -o *.zip -d _extract
          find _extract -maxdepth 4 -type d

      - name: Locate PROJECT_ROOT
        shell: bash
        run: |
          ROOT=$(find _extract -name Tweak.mm | head -n1 | xargs dirname)
          echo "PROJECT_ROOT=$ROOT" >> $GITHUB_ENV

      - name: Setup Theos
        shell: bash
        run: |
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV
          echo "$HOME/theos/bin" >> $GITHUB_PATH
          git clone https://github.com/theos/sdks.git $HOME/theos/sdks
          brew install ldid

      - name: Inject clean Makefile (NO SSZipArchive)
        shell: bash
        run: |
          cd "$PROJECT_ROOT"
          rm -f Makefile

          cat <<'EOF' > Makefile
          TARGET := iphone:clang:latest:14.0
          ARCHS = arm64
          THEOS_PACKAGE_SCHEME = rootless

          include $(THEOS)/makefiles/common.mk

          TWEAK_NAME = UEDumper

          UEDumper_FILES = \
            $(wildcard *.mm) \
            $(wildcard src/*.mm) \
            $(wildcard src/*.cpp) \
            $(wildcard deps/KittyMemory/KittyMemory/*.cpp)

          UEDumper_CFLAGS = -fobjc-arc
          UEDumper_CCFLAGS = -std=c++17 -Ideps/KittyMemory

          UEDumper_FRAMEWORKS = UIKit Foundation

          include $(THEOS_MAKE_PATH)/tweak.mk
          EOF

      - name: Remove SSZipArchive usage from code
        shell: bash
        run: |
          cd "$PROJECT_ROOT"
          sed -i '' '/SSZipArchive/d' src/Tweak.mm || true

      - name: Build
        shell: bash
        run: |
          cd "$PROJECT_ROOT"
          make clean
          make package FINALPACKAGE=1

      - name: Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper
          path: ${{ env.PROJECT_ROOT }}/packages/*.deb
