name: Smart Theos Build (Zip Auto-Find + Auto-Deps + Auto-Makefile)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # 1) Extract ALL zip(s) into _extract + print full tree
      # ------------------------------------------------------------
      - name: 1) Unzip zip(s) + print full tree
        shell: bash
        run: |
          set -euo pipefail

          rm -rf _extract
          mkdir -p _extract

          echo "üîé Searching for zip files in repo root..."
          ls -la

          ZIPS_FOUND=0
          for z in *.zip; do
            if [ -f "$z" ]; then
              ZIPS_FOUND=1
              echo "üì¶ Unzipping: $z -> _extract/"
              unzip -o -q "$z" -d _extract
            fi
          done

          if [ "$ZIPS_FOUND" -eq 0 ]; then
            echo "‚ö†Ô∏è No zip files found in repo root. Using repository files as-is."
            # ŸÑŸà ŸÖÿßŸÉŸà zipÿå ŸÜÿπÿ™ÿ®ÿ± ÿßŸÑÿ¨ÿ∞ÿ± ŸáŸà ŸÜŸÅÿ≥Ÿá
            rm -rf _extract
            mkdir -p _extract
            rsync -a ./ _extract/ --exclude _extract --exclude .git --exclude .github
          fi

          echo "‚úÖ FULL TREE (first 400 lines):"
          (cd _extract && find . -maxdepth 8 -print | sed -n '1,400p')

      # ------------------------------------------------------------
      # 2) Locate PROJECT_ROOT automatically (Tweak folder)
      # ------------------------------------------------------------
      - name: 2) Locate PROJECT_ROOT (auto)
        shell: bash
        run: |
          set -euo pipefail

          # ŸÜÿπÿ™ÿ®ÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸáŸà ÿßŸÑŸÖÿ¨ŸÑÿØ ÿßŸÑÿ∞Ÿä Ÿäÿ≠ÿ™ŸàŸä Makefile ÿ£Ÿà control ÿ£Ÿà Tweak.xm/.mm
          CANDIDATE="$(
            find _extract -type f \( \
              -name "Makefile" -o \
              -name "control" -o \
              -name "Tweak.xm" -o -name "Tweak.mm" -o -name "Tweak.m" \
            \) | head -n 1
          )"

          if [ -z "${CANDIDATE:-}" ]; then
            echo "‚ùå Could not locate project root (no Makefile/control/Tweak.* found)."
            echo "üëâ ÿßÿ∑ÿ®ÿπ ÿßŸÑÿ¥ÿ¨ÿ±ÿ© Ÿàÿ¥ŸàŸÅ ŸàŸäŸÜ ŸÖŸÑŸÅÿßÿ™ Tweak/Makefile/control ÿØÿßÿÆŸÑ zip."
            exit 1
          fi

          PROJECT_ROOT="$(dirname "$CANDIDATE")"
          # ŸÑŸà ŸÉÿßŸÜ ÿßŸÑŸÖŸÑŸÅ ÿØÿßÿÆŸÑ src/ ŸÜÿ∑ŸÑÿπ ÿÆÿ∑Ÿàÿ©
          if [ "$(basename "$PROJECT_ROOT")" = "src" ]; then
            PROJECT_ROOT="$(dirname "$PROJECT_ROOT")"
          fi

          echo "‚úÖ PROJECT_ROOT = $PROJECT_ROOT"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> "$GITHUB_ENV"

      # ------------------------------------------------------------
      # 3) Fix deps: KittyMemory + SSZipArchive + fmt (+ Keystone fix flags)
      # ------------------------------------------------------------
      - name: 3) Fix deps (KittyMemory + SSZipArchive + fmt) + print include dirs
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          mkdir -p deps

          # ---------- KittyMemory ----------
          KITTY_HDR="$(find .. -type f -name "KittyInclude.hpp" 2>/dev/null | head -n 1 || true)"
          if [ -z "${KITTY_HDR:-}" ]; then
            echo "‚ö†Ô∏è KittyInclude.hpp not found -> cloning KittyMemory..."
            rm -rf deps/KittyMemory
            git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
            KITTY_HDR="$(find deps/KittyMemory -type f -name "KittyInclude.hpp" | head -n 1)"
          else
            echo "‚úÖ Found KittyInclude.hpp at: $KITTY_HDR"
            # ŸÜŸÜŸÇŸÑ/ŸÜŸÜÿ≥ÿÆ ÿßŸÑŸÖŸÉÿ™ÿ®ÿ© ÿ•ŸÑŸâ deps/KittyMemory ŸÑŸà ŸÉÿßŸÜÿ™ ÿÆÿßÿ±ÿ¨Ÿáÿß
            if ! echo "$KITTY_HDR" | grep -q "/deps/KittyMemory/"; then
              echo "üì¶ Copying KittyMemory into deps/KittyMemory ..."
              rm -rf deps/KittyMemory
              mkdir -p deps/KittyMemory
              # ŸÜÿ£ÿÆÿ∞ ÿßŸÑŸÖÿ¨ŸÑÿØ ÿßŸÑÿ£ÿπŸÑŸâ ÿßŸÑŸÑŸä Ÿäÿ≠ÿ™ŸàŸä KittyInclude.hpp
              KITTY_DIR="$(dirname "$KITTY_HDR")"
              cp -R "$KITTY_DIR"/* deps/KittyMemory/ || true
            fi
          fi

          # ÿßÿ≥ÿ™ÿÆÿ±ÿ¨ ŸÖÿ≥ÿßÿ± include ÿßŸÑÿµÿ≠ (ÿ∫ÿßŸÑÿ®ÿßŸã KittyMemory/KittyMemory)
          KITTY_INC_DIR="$(dirname "$(find deps/KittyMemory -type f -name 'KittyInclude.hpp' | head -n 1)")"
          echo "‚úÖ KITTY_INC_DIR=$KITTY_INC_DIR"
          echo "KITTY_INC_DIR=$KITTY_INC_DIR" >> "$GITHUB_ENV"

          # ---------- SSZipArchive ----------
          SSZIP_HDR="$(find .. -type f -path "*SSZipArchive*" -name "ZipArchive.h" 2>/dev/null | head -n 1 || true)"
          if [ -z "${SSZIP_HDR:-}" ]; then
            echo "‚ö†Ô∏è SSZipArchive/ZipArchive.h not found -> cloning SSZipArchive..."
            rm -rf deps/SSZipArchive
            git clone --depth=1 https://github.com/ZipArchive/ZipArchive.git deps/SSZipArchive
            # Header location varies; we will include the repo root
          else
            echo "‚úÖ Found ZipArchive.h at: $SSZIP_HDR"
            if ! echo "$SSZIP_HDR" | grep -q "/deps/SSZipArchive/"; then
              echo "üì¶ Copying SSZipArchive into deps/SSZipArchive ..."
              rm -rf deps/SSZipArchive
              mkdir -p deps/SSZipArchive
              SSZIP_DIR="$(dirname "$SSZIP_HDR")"
              cp -R "$SSZIP_DIR"/.. deps/SSZipArchive/ || true
            fi
          fi
          echo "SSZIP_DIR=deps/SSZipArchive" >> "$GITHUB_ENV"

          # ---------- fmt ----------
          echo "üç∫ Installing fmt (brew)..."
          brew update >/dev/null 2>&1 || true
          brew install fmt >/dev/null

          FMT_PREFIX="$(brew --prefix fmt)"
          echo "‚úÖ FMT_PREFIX=$FMT_PREFIX"
          echo "FMT_PREFIX=$FMT_PREFIX" >> "$GITHUB_ENV"

          echo "‚úÖ Include dirs summary:"
          echo "  - KITTY_INC_DIR: $KITTY_INC_DIR"
          echo "  - SSZIP_DIR   : deps/SSZipArchive"
          echo "  - FMT_PREFIX  : $FMT_PREFIX"

      # ------------------------------------------------------------
      # 4) Delete old Makefile + generate a NEW smart Makefile
      #    - excludes KittyMemory examples (android etc)
      #    - adds include flags for Kitty + SSZipArchive + fmt
      #    - Keystone fix: -fno-modules + -Wno-module-import-in-extern-c
      # ------------------------------------------------------------
      - name: 4) Delete old Makefile + generate NEW smart Makefile
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          echo "üßπ Removing old Makefile (if any)..."
          rm -f Makefile

          TWEAK_NAME="UEDumper"

          echo "üîé Collecting project source files (excluding deps examples/.theos)..."
          # ŸÜŸÑÿ™ŸÇÿ∑ ŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸÅŸÇÿ∑ + ŸÖŸÑŸÅÿßÿ™ KittyMemory ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© (ÿ®ÿØŸàŸÜ examples)
          SRC_LIST="$(
            find . -type f \( -name "*.xm" -o -name "*.mm" -o -name "*.m" -o -name "*.cpp" \) \
              -not -path "./.theos/*" \
              -not -path "./deps/KittyMemory/example-android/*" \
              -not -path "./deps/KittyMemory/examples/*" \
              -not -path "./deps/KittyMemory/example/*" \
              -not -path "./deps/SSZipArchive/*Tests/*" \
              -print \
            | sed 's|^\./||'
          )"

          if [ -z "${SRC_LIST:-}" ]; then
            echo "‚ùå No source files found in PROJECT_ROOT."
            exit 1
          fi

          echo "‚úÖ Found $(echo "$SRC_LIST" | wc -l | tr -d ' ') source files."

          # ÿµŸäÿßÿ∫ÿ© ŸÖŸÑŸÅÿßÿ™ Theos: ŸÉŸÑ ÿ≥ÿ∑ÿ± " \"
          FILES_FMT=""
          while IFS= read -r f; do
            [ -z "$f" ] && continue
            FILES_FMT="${FILES_FMT}\n  ${f} \\"
          done <<< "$SRC_LIST"

          # ÿßÿ≠ÿ∞ŸÅ ÿ¢ÿÆÿ± "\" (ÿßÿÆÿ™Ÿäÿßÿ±Ÿäÿå ŸÖŸà ŸÑÿßÿ≤ŸÖ ÿ®ÿ≥ ÿ£ŸÜÿ∏ŸÅ)
          FILES_FMT="$(printf "%b" "$FILES_FMT" | sed '$ s/ \\$//')"

          cat > Makefile <<EOF
          TARGET := iphone:clang:latest:14.0
          ARCHS := arm64 arm64e
          THEOS_PACKAGE_SCHEME := rootless

          include \$(THEOS)/makefiles/common.mk

          TWEAK_NAME := ${TWEAK_NAME}

          ${TWEAK_NAME}_FILES :=${FILES_FMT}

          ${TWEAK_NAME}_FRAMEWORKS := UIKit Foundation Security
          ${TWEAK_NAME}_LIBRARIES := stdc++

          # ---- includes ----
          KITTY_INC := ${KITTY_INC_DIR}
          SSZIP_INC := deps/SSZipArchive
          FMT_INC   := ${FMT_PREFIX}/include
          FMT_LIB   := ${FMT_PREFIX}/lib

          # Keystone/modules fix + general fixes
          COMMON_FIX := -fno-modules -Wno-module-import-in-extern-c -Wno-error -Wno-deprecated-declarations -Wno-unused-variable -Wno-unused-parameter

          ${TWEAK_NAME}_CFLAGS   += \$(COMMON_FIX) -fobjc-arc -I. -I\$(KITTY_INC) -I\$(SSZIP_INC) -I\$(FMT_INC)
          ${TWEAK_NAME}_CCFLAGS  += \$(COMMON_FIX) -std=c++17 -I. -I\$(KITTY_INC) -I\$(SSZIP_INC) -I\$(FMT_INC)
          ${TWEAK_NAME}_LDFLAGS  += -L\$(FMT_LIB) -lfmt

          include \$(THEOS_MAKE_PATH)/tweak.mk
          EOF

          echo "‚úÖ New Makefile generated."
          echo "---- Makefile (first 200 lines) ----"
          sed -n '1,200p' Makefile

      # ------------------------------------------------------------
      # 5) Setup Theos clean + SDKs (fix sdks exists error)
      # ------------------------------------------------------------
      - name: 5) Setup Theos (clean) + SDKs
        shell: bash
        run: |
          set -euo pipefail

          rm -rf "$HOME/theos"
          git clone --recursive --depth=1 https://github.com/theos/theos.git "$HOME/theos"

          echo "THEOS=$HOME/theos" >> "$GITHUB_ENV"
          echo "$HOME/theos/bin" >> "$GITHUB_PATH"

          # FIX: sdks already exists
          rm -rf "$HOME/theos/sdks"
          git clone --depth=1 https://github.com/theos/sdks.git "$HOME/theos/sdks"

          # optional: remove older SDKs to speed up
          rm -rf "$HOME/theos/sdks/iPhoneOS"{9..13}".sdk" || true

          brew install ldid xz >/dev/null

      # ------------------------------------------------------------
      # 6) Build package
      # ------------------------------------------------------------
      - name: 6) Build (package)
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          echo "üöÄ Building..."
          make clean || true
          make package FINALPACKAGE=1 messages=yes THEOS_PACKAGE_SCHEME=rootless

          echo "‚úÖ Build output:"
          ls -la packages || true
          find .theos -maxdepth 4 -type f -name "*.dylib" -print || true

      # ------------------------------------------------------------
      # 7) Upload artifacts (deb + dylib if exists)
      # ------------------------------------------------------------
      - name: 7) Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Build_Output
          path: |
            ${{ env.PROJECT_ROOT }}/packages/*.deb
            ${{ env.PROJECT_ROOT }}/.theos/**/**/*.dylib
          
