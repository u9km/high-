name: Theos Build (Zip Project Auto-Fix)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # 1) Unzip: ÙŠÙÙƒ Ø£ÙŠ zip Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ø¬Ø°Ø± Ø¥Ù„Ù‰ _extract ÙˆÙŠØ·Ø¨Ø¹ Ø´Ø¬Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
      # ------------------------------------------------------------
      - name: 1) Unzip zip(s) + print full tree
        shell: bash
        run: |
          set -euo pipefail
          rm -rf _extract
          mkdir -p _extract

          echo "ğŸ” Searching for zip files in repo root..."
          ls -la
          shopt -s nullglob
          ZIPS=( *.zip )
          if [ ${#ZIPS[@]} -eq 0 ]; then
            echo "âŒ No zip found in repo root."
            exit 1
          fi

          for z in "${ZIPS[@]}"; do
            echo "ğŸ“¦ Unzipping: $z"
            unzip -o -q "$z" -d _extract
          done

          echo "âœ… Extracted tree (depth 6):"
          find _extract -maxdepth 6 -print

      # ------------------------------------------------------------
      # 2) Locate PROJECT_ROOT: ÙŠØ¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù Tweak (xm/mm) ÙˆÙŠØ­Ø¯Ø¯ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
      # ------------------------------------------------------------
      - name: 2) Locate PROJECT_ROOT (auto)
        shell: bash
        run: |
          set -euo pipefail

          # Ù†Ø¯ÙˆÙ‘Ø± Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª Ø§Ù„Ù€ tweak Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
          HIT="$(find _extract -type f \( -name 'Tweak.xm' -o -name 'Tweak.mm' -o -name 'Tweak.x' \) | head -n 1 || true)"

          if [ -z "${HIT}" ]; then
            echo "âŒ Couldn't find Tweak.xm / Tweak.mm / Tweak.x inside zip."
            echo "Dumping candidates (mm/xm) up to 30:"
            find _extract -type f \( -name '*.xm' -o -name '*.mm' \) | head -n 30
            exit 1
          fi

          # PROJECT_ROOT = Ù…Ø¬Ù„Ø¯ ÙŠØ­ØªÙˆÙŠ Ù…Ù„Ù Tweak.* ÙˆØºØ§Ù„Ø¨Ø§Ù‹ Ø¨Ø¬Ù†Ø¨Ù‡ src/ Ùˆ deps/
          PROJECT_ROOT="$(dirname "$HIT")"

          # Ø¥Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø¯Ø§Ø®Ù„ src/ Ø±Ø¬Ù‘Ø¹ Ø®Ø·ÙˆØ© Ù„Ù„Ø®Ù„Ù
          if [ "$(basename "$PROJECT_ROOT")" = "src" ]; then
            PROJECT_ROOT="$(dirname "$PROJECT_ROOT")"
          fi

          echo "âœ… Found tweak file: $HIT"
          echo "âœ… PROJECT_ROOT: $PROJECT_ROOT"

          echo "PROJECT_ROOT=$PROJECT_ROOT" >> "$GITHUB_ENV"

      # ------------------------------------------------------------
      # 3) Ensure deps: KittyMemory + SSZipArchive
      #   - ÙŠØµÙ„Ù‘Ø­ include paths ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      # ------------------------------------------------------------
      - name: 3) Fix deps (KittyMemory + SSZipArchive) and print exact include dirs
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"
          mkdir -p deps

          # ---------- KittyMemory ----------
          KITTY_HDR="$(find .. -type f -name 'KittyInclude.hpp' | head -n 1 || true)"
          if [ -z "${KITTY_HDR}" ]; then
            echo "âš ï¸ KittyInclude.hpp not found -> cloning KittyMemory..."
            rm -rf deps/KittyMemory
            git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
            KITTY_HDR="$(find deps/KittyMemory -type f -name 'KittyInclude.hpp' | head -n 1 || true)"
          fi

          if [ -z "${KITTY_HDR}" ]; then
            echo "âŒ KittyMemory still not found after clone."
            exit 1
          fi

          KITTY_INC_DIR="$(dirname "$KITTY_HDR")"
          echo "âœ… KittyInclude.hpp = $KITTY_HDR"
          echo "âœ… KITTY_INC_DIR   = $KITTY_INC_DIR"
          echo "KITTY_INC_DIR=$KITTY_INC_DIR" >> "$GITHUB_ENV"

          # ---------- SSZipArchive ----------
          # Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯Ù‡ include <SSZipArchive/ZipArchive.h> Ø£Ùˆ <SSZipArchive/SSZipArchive.h>
          SS_HDR="$(find .. -type f \( -name 'SSZipArchive.h' -o -name 'ZipArchive.h' \) | head -n 1 || true)"
          if [ -z "${SS_HDR}" ]; then
            echo "âš ï¸ SSZipArchive headers not found -> cloning ZipArchive..."
            rm -rf deps/ZipArchive
            git clone --depth=1 https://github.com/ZipArchive/ZipArchive.git deps/ZipArchive

            # ØºØ§Ù„Ø¨Ø§Ù‹ Ø§Ù„Ù…Ø³Ø§Ø±: deps/ZipArchive/Sources/SSZipArchive/SSZipArchive.h
            SS_HDR="$(find deps/ZipArchive -type f \( -name 'SSZipArchive.h' -o -name 'ZipArchive.h' \) | head -n 1 || true)"
          fi

          if [ -z "${SS_HDR}" ]; then
            echo "âŒ SSZipArchive not found. (Your code imports SSZipArchive/ZipArchive.h)"
            exit 1
          fi

          # include dir Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø§Ù„Ø£Ø¨ Ø§Ù„Ù„ÙŠ ÙŠØ­ØªÙˆÙŠ Ù…Ø¬Ù„Ø¯ SSZipArchive
          # Ù…Ø«Ø§Ù„: .../Sources  Ø¨Ø­ÙŠØ« ÙŠØµÙŠØ± include <SSZipArchive/SSZipArchive.h> ØµØ­ÙŠØ­
          SSZIP_SSZ_DIR="$(dirname "$SS_HDR")"                # .../SSZipArchive
          SSZIP_PARENT="$(dirname "$SSZIP_SSZ_DIR")"         # .../Sources (Ø£Ùˆ Ø´ÙŠØ¡ Ù…Ø´Ø§Ø¨Ù‡)
          echo "âœ… SSZipArchive header = $SS_HDR"
          echo "âœ… SSZIP_INCLUDE_BASE  = $SSZIP_PARENT"
          echo "SSZIP_INCLUDE_BASE=$SSZIP_PARENT" >> "$GITHUB_ENV"

          echo "ğŸ“Œ Include dirs summary:"
          echo "  KITTY_INC_DIR      = $KITTY_INC_DIR"
          echo "  SSZIP_INCLUDE_BASE = $SSZIP_PARENT"

      # ------------------------------------------------------------
      # 4) Generate NEW Makefile (ÙŠØ­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…) ÙˆÙŠØ¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙØ¹Ù„ÙŠØ§Ù‹
      #    - ÙŠØ³ØªØ«Ù†ÙŠ Ø£Ù…Ø«Ù„Ø© KittyMemory (example-android) ÙˆØ£ÙŠ Ù…Ø¬Ù„Ø¯Ø§Øª tests
      # ------------------------------------------------------------
      - - name: 4) Delete old Makefile + generate new smart Makefile (SAFE)
        shell: bash
        run: |
          set -e
          cd "$PROJECT_ROOT"

          echo "ğŸ—‘ï¸ Removing old Makefile..."
          rm -f Makefile

          echo "ğŸ§  Generating SAFE Makefile..."

          {
            echo "TARGET := iphone:clang:latest:14.0"
            echo "ARCHS := arm64 arm64e"
            echo "THEOS_PACKAGE_SCHEME := rootless"
            echo
            echo "include \$(THEOS)/makefiles/common.mk"
            echo
            echo "TWEAK_NAME := UEDumper"
            echo
            echo "UEDumper_FILES := \\"
          } > Makefile

          # Ù†Ø¶ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø³Ø·Ø± Ø³Ø·Ø± (Ø¢Ù…Ù† 100%)
          find . -type f \
            \( -name '*.xm' -o -name '*.x' -o -name '*.mm' -o -name '*.m' -o -name '*.cpp' -o -name '*.c' \) \
            -not -path './.theos/*' \
            -not -path './deps/KittyMemory/example-android/*' \
            -not -path './deps/KittyMemory/examples/*' \
            -not -path './deps/ZipArchive/Tests/*' \
            -not -path './deps/ZipArchive/Example/*' \
            | sed 's|^\./||' \
            | sort \
            | while read -r f; do
                echo "  $f \\" >> Makefile
              done

          {
            echo
            echo "UEDumper_FRAMEWORKS := UIKit Foundation Security"
            echo "UEDumper_CFLAGS += -fobjc-arc -Wno-error -Wno-unused-variable -Wno-unused-function"
            echo "UEDumper_CCFLAGS += -std=c++17"
            echo
            echo "include \$(THEOS_MAKE_PATH)/tweak.mk"
          } >> Makefile

          echo "âœ… Makefile generated successfully"
          echo "---- Makefile preview ----"
          sed -n '1,120p' Makefile

      # ------------------------------------------------------------
      # 5) Setup Theos + SDKs (ÙŠØ­Ø°Ù sdks Ù‚Ø¨Ù„ clone Ù„ØªØ¬Ù†Ø¨ 'already exists')
      # ------------------------------------------------------------
      - name: 5) Setup Theos (clean) + SDKs
        shell: bash
        run: |
          set -euo pipefail

          rm -rf "$HOME/theos"
          git clone --recursive --depth=1 https://github.com/theos/theos.git "$HOME/theos"

          echo "THEOS=$HOME/theos" >> "$GITHUB_ENV"
          echo "$HOME/theos/bin" >> "$GITHUB_PATH"

          # Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ø­ØªÙ‰ Ù…Ø§ ÙŠØ·Ù„Ø¹: destination path .../sdks already exists
          rm -rf "$HOME/theos/sdks"
          git clone --depth=1 https://github.com/theos/sdks.git "$HOME/theos/sdks"

          # ØªØ³Ø±ÙŠØ¹
          rm -rf "$HOME/theos/sdks/iPhoneOS"{9..13}.sdk || true

          brew update
          brew install ldid xz fmt

      # ------------------------------------------------------------
      # 6) Build (ÙŠÙ…Ø±Ø± include/lib paths Ù…Ø¨Ø§Ø´Ø±Ø©) + ÙŠØ·Ù„Ø¹ deb + dylib
      # ------------------------------------------------------------
      - name: 6) Build package (force include dirs for Kitty + SSZipArchive + fmt)
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          # Ù…Ø³Ø§Ø±Ø§Øª fmt ÙÙŠ macos-latest (Apple Silicon)
          FMT_PREFIX="$(brew --prefix fmt)"
          echo "âœ… FMT_PREFIX=$FMT_PREFIX"

          # Ø§Ø³ØªØ®Ø¯Ù… include dirs Ø§Ù„Ù„ÙŠ Ø·Ù„Ø¹Ù†Ø§Ù‡Ø§
          echo "âœ… KITTY_INC_DIR=$KITTY_INC_DIR"
          echo "âœ… SSZIP_INCLUDE_BASE=$SSZIP_INCLUDE_BASE"

          # Ù†Ù…Ø±Ø±Ù‡Ø§ ÙƒÙ€ flags:
          export CFLAGS="$CFLAGS -I$KITTY_INC_DIR -I$SSZIP_INCLUDE_BASE -I$FMT_PREFIX/include"
          export CXXFLAGS="$CXXFLAGS -I$KITTY_INC_DIR -I$SSZIP_INCLUDE_BASE -I$FMT_PREFIX/include"
          export LDFLAGS="$LDFLAGS -L$FMT_PREFIX/lib -lfmt"

          make clean || true
          make package FINALPACKAGE=1 messages=yes

          echo "âœ… Build output:"
          find packages -maxdepth 2 -type f || true
          find .theos -maxdepth 6 -type f -name '*.dylib' -o -name '*.deb' || true

      # ------------------------------------------------------------
      # 7) Upload artifacts
      # ------------------------------------------------------------
      - name: 7) Upload DEB + dylib (if exists)
        uses: actions/upload-artifact@v4
        with:
          name: build_output
          path: |
            ${{ env.PROJECT_ROOT }}/packages/*.deb
            ${{ env.PROJECT_ROOT }}/.theos/obj/**/*.dylib
            ${{ env.PROJECT_ROOT }}/.theos/obj/*.dylib
