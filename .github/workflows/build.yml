name: Ultimate UEDumper (Non-Jailbreak Dylib)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # 1) ÙÙƒ Ø§Ù„Ø¶ØºØ· Ø¹Ù† ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„Ù…ØªØ¯Ø§Ø®Ù„Ø©)
      # ------------------------------------------------------------
      - name: 1) Unzip ALL zips recursively
        shell: bash
        run: |
          set -euo pipefail
          rm -rf _extract
          mkdir -p _extract
          echo "ğŸ” Searching for zip files..."
          find . -maxdepth 1 -type f -name "*.zip" -print
          while IFS= read -r z; do
            base="$(basename "$z" .zip)"
            dest="_extract/$base"
            mkdir -p "$dest"
            unzip -o -q "$z" -d "$dest"
          done < <(find . -maxdepth 1 -type f -name "*.zip" -print)
          
          # ÙÙƒ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªØ¯Ø§Ø®Ù„
          for i in 1 2 3; do
            nested_count="$(find _extract -type f -name "*.zip" | wc -l | tr -d ' ')"
            if [ "$nested_count" = "0" ]; then break; fi
            echo "â¡ï¸ Pass $i: found nested zips"
            while IFS= read -r nz; do
              ndest="$(dirname "$nz")/__unzipped__$(basename "$nz" .zip)"
              mkdir -p "$ndest"
              unzip -o -q "$nz" -d "$ndest" || true
              rm -f "$nz"
            done < <(find _extract -type f -name "*.zip" -print)
          done

      # ------------------------------------------------------------
      # 2) ØªØ­Ø¯ÙŠØ¯ Ù…ÙƒØ§Ù† Makefile
      # ------------------------------------------------------------
      - name: 2) Locate PROJECT_ROOT
        shell: bash
        run: |
          set -euo pipefail
          MF=""
          while IFS= read -r f; do
            if grep -qE "THEOS|common\.mk|tweak\.mk" "$f" 2>/dev/null; then
              MF="$f"
              break
            fi
          done < <(find _extract -type f -name "Makefile" -print)
          
          if [ -z "${MF}" ]; then MF="$(find _extract -type f -name "Makefile" | head -n 1 || true)"; fi
          if [ -z "${MF}" ]; then echo "âŒ No Makefile found."; exit 1; fi
          
          PROJECT_ROOT="$(cd "$(dirname "$MF")" && pwd)"
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> "$GITHUB_ENV"
          echo "âœ… Project found at: $PROJECT_ROOT"

      # ------------------------------------------------------------
      # 3 & 4) ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª (KittyMemory + fmt)
      # ------------------------------------------------------------
      - name: 3) Ensure Dependencies
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"
          mkdir -p deps
          
          # KittyMemory
          KITTY_H="$(find "$PROJECT_ROOT" -type f -name "KittyInclude.hpp" | head -n 1 || true)"
          if [ -z "${KITTY_H}" ]; then
            git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
            KITTY_H="$(find "$PROJECT_ROOT/deps/KittyMemory" -type f -name "KittyInclude.hpp" | head -n 1)"
          fi
          KITTY_INC_DIR="$(cd "$(dirname "$KITTY_H")" && pwd)"
          echo "KITTY_INC_DIR=$KITTY_INC_DIR" >> "$GITHUB_ENV"
          
          # fmt
          FMT_H="$(find "$PROJECT_ROOT" -type f -path "*/fmt/format.h" | head -n 1 || true)"
          if [ -z "${FMT_H}" ]; then
            git clone --depth=1 https://github.com/fmtlib/fmt.git deps/fmt
            FMT_H="$(find "$PROJECT_ROOT/deps/fmt" -type f -path "*/fmt/format.h" | head -n 1)"
          fi
          # Check if include/fmt or just fmt
          if echo "$FMT_H" | grep -q "/include/fmt/format.h"; then
             FMT_INC_DIR="$(cd "$(dirname "$(dirname "$FMT_H")")" && pwd)"
          else
             FMT_INC_DIR="$(cd "$(dirname "$(dirname "$FMT_H")")" && pwd)"
          fi
          echo "FMT_INC_DIR=$FMT_INC_DIR" >> "$GITHUB_ENV"

      # ------------------------------------------------------------
      # 5) Ø¥ØµÙ„Ø§Ø­ Makefile ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      # ------------------------------------------------------------
      - name: 5) Auto-fix Makefile
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"
          MF="Makefile"
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ø§Ø©
          PREFIX="$(grep -E '^[A-Za-z0-9_]+_NAME\s*=' "$MF" | head -n 1 | cut -d'_' -f1 || true)"
          if [ -z "${PREFIX}" ]; then PREFIX="UEDumper"; fi
          
          # Ø¥ØµÙ„Ø§Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ù„ØªØ´Ù…Ù„ ÙƒÙ„ Ø´ÙŠØ¡ (Wildcards)
          if grep -qE "^${PREFIX}_FILES\s*=" "$MF"; then
            perl -0777 -i -pe "s/^${PREFIX}_FILES\\s*=.*?(\\n\\n|\\ninclude )/${PREFIX}_FILES = \$(wildcard *.xm) \$(wildcard *.mm) \$(wildcard *.m) \$(wildcard src/*.xm) \$(wildcard src/*.mm) \$(wildcard src/*.cpp) \$(wildcard *.cpp)\\n\\n\\1/sm" "$MF" || true
          else
            echo "${PREFIX}_FILES = \$(wildcard *.xm) \$(wildcard *.mm) \$(wildcard *.m) \$(wildcard *.cpp)" >> "$MF"
          fi

          # Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªØ¶Ù…ÙŠÙ†
          {
            echo ""
            echo "${PREFIX}_CCFLAGS += -std=c++17 -I\"$KITTY_INC_DIR\" -I\"$FMT_INC_DIR\" -DFMT_HEADER_ONLY"
            echo "${PREFIX}_CFLAGS  += -I\"$KITTY_INC_DIR\" -I\"$FMT_INC_DIR\""
          } >> "$MF"

      # ------------------------------------------------------------
      # 6) ØªØ«Ø¨ÙŠØª Theos
      # ------------------------------------------------------------
      - name: 6) Setup Theos
        shell: bash
        run: |
          rm -rf "$HOME/theos"
          git clone --recursive --depth=1 https://github.com/theos/theos.git "$HOME/theos"
          echo "THEOS=$HOME/theos" >> "$GITHUB_ENV"
          rm -rf "$HOME/theos/sdks"
          git clone --depth=1 https://github.com/theos/sdks.git "$HOME/theos/sdks"
          brew install ldid xz

      # ------------------------------------------------------------
      # 7) Ø§Ù„Ø¨Ù†Ø§Ø¡ (Ù„Ù„Ø­Ù‚Ù† Ø¨Ø¯ÙˆÙ† Ø¬Ù„Ø¨Ø±ÙŠÙƒ)
      # ------------------------------------------------------------
      - name: 7) Build for Injection
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"
          
          echo "ğŸš€ Building..."
          make clean || true
          # Ù‡Ù†Ø§ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ Ù„Ø¥Ù†ØªØ§Ø¬ dylib Ù…ØªÙˆØ§ÙÙ‚
          make package FINALPACKAGE=1 messages=yes

          echo "ğŸ“¦ Preparing files for upload..."
          mkdir -p output_files
          
          # Ù†Ø³Ø® Ù…Ù„Ù DEB
          cp packages/*.deb output_files/ 2>/dev/null || true
          
          # Ø£Ù‡Ù… Ø®Ø·ÙˆØ© Ù„Ù„Ø¨Ø¯ÙˆÙ† Ø¬Ù„Ø¨Ø±ÙŠÙƒ: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù€ dylib
          # Ø¹Ø§Ø¯Ø© ÙŠÙƒÙˆÙ† ÙÙŠ .theos/obj/debug Ø£Ùˆ .theos/obj
          find .theos/obj -name "*.dylib" -exec cp {} output_files/ \;
          
          echo "âœ… Files ready:"
          ls -la output_files/

      - name: Upload Files (Dylib & Deb)
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_NoJailbreak
          path: ${{ env.PROJECT_ROOT }}/output_files/*
