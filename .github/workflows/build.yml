name: Force Build (Auto-Rewrite Makefile)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. فك الضغط والبحث عن مكان الكود تلقائياً
      - name: Unzip and Find Source
        run: |
          unzip -o -q *.zip
          
          # ابحث عن أي ملف ينتهي بـ .xm أو .mm لنعرف أين يوجد السورس
          # وننتقل لهذا المجلد
          SOURCE_FILE=$(find . -name "*.xm" -o -name "*.mm" | head -n 1)
          if [ -z "$SOURCE_FILE" ]; then
            echo "ERROR: No source code found!"
            exit 1
          fi
          
          PROJECT_DIR=$(dirname "$SOURCE_FILE")
          echo "Found source code in: $PROJECT_DIR"
          
          # حفظ مسار المشروع لاستخدامه في الخطوات القادمة
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV

      # 2. تحميل المكتبات المطلوبة يدوياً (لضمان وجودها)
      - name: Force Install Dependencies
        run: |
          cd ${{ env.PROJECT_DIR }}
          mkdir -p deps
          
          # مسح القديم وتحميل جديد نظيف
          rm -rf deps/KittyMemory deps/fmt
          
          git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
          git clone --depth=1 https://github.com/fmtlib/fmt.git deps/fmt

      # 3. كتابة ملف Makefile جديد (هنا السر: لن نعتمد على ملفك القديم)
      - name: Generate Fresh Makefile
        run: |
          cd ${{ env.PROJECT_DIR }}
          
          # حذف الـ Makefile القديم لتجنب المشاكل
          rm -f Makefile
          
          # كتابة ملف جديد يجمع كل الملفات الموجودة ويجهزها للحقن
          cat > Makefile <<EOF
          TARGET := iphone:clang:latest:14.0
          ARCHS = arm64
          
          include \$(THEOS)/makefiles/common.mk

          TWEAK_NAME = UEDumper

          # جمع كل ملفات السورس تلقائياً
          UEDumper_FILES = \$(wildcard *.xm) \$(wildcard *.mm) \$(wildcard *.cpp) \$(wildcard src/*.cpp) \$(wildcard src/*.mm)
          
          # إعدادات المكتبات (KittyMemory + fmt)
          UEDumper_CCFLAGS = -std=c++17 -I"deps/KittyMemory" -I"deps/fmt/include" -DFMT_HEADER_ONLY
          UEDumper_CFLAGS = -I"deps/KittyMemory" -I"deps/fmt/include"
          
          include \$(THEOS_MAKE_PATH)/tweak.mk
          EOF
          
          echo "Created new Makefile content:"
          cat Makefile

      # 4. تثبيت Theos
      - name: Setup Theos
        uses: actions/checkout@v4
        with:
          repository: theos/theos
          path: theos
          ref: master

      # 5. البناء واستخراج Dylib
      - name: Build & Extract Dylib
        run: |
          export THEOS=$(pwd)/theos
          cd ${{ env.PROJECT_DIR }}
          
          # تنظيف وبناء
          make clean
          make package FINALPACKAGE=1 messages=yes
          
          # تجهيز ملف Dylib للتحميل
          mkdir -p ../output
          
          # نسخ ملف Dylib (المهم للحقن بدون جلبريك)
          # نجده عادة في المجلد المخفي .theos/obj/debug/arm64/
          find .theos -name "*.dylib" -exec cp {} ../output/UEDumper_NoJailbreak.dylib \;
          
          # نسخ ملف DEB أيضاً
          cp packages/*.deb ../output/ 2>/dev/null || true

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_File
          path: output/*
