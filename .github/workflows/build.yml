name: UEDumper (Smart Zip + Auto Deps + No Jailbreak)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------------------
      # 1) Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø°ÙƒÙŠ Ù„ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¶ØºÙˆØ·Ø© (Ø­ØªÙ‰ Ø§Ù„Ù…ØªØ¯Ø§Ø®Ù„Ø©)
      # ---------------------------------------------------------
      - name: 1) Extract all zip files (recursive)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf _extract
          mkdir -p _extract

          echo "ğŸ” Searching for zip files (top-level)..."
          # Ù†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¶ØºÙˆØ·Ø© Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù…Ù„
          find . -maxdepth 2 -type f -name "*.zip" -print0 | while IFS= read -r -d '' z; do
            echo "ğŸ“¦ Unzipping: $z"
            unzip -o -q "$z" -d _extract
          done

          # Ø­Ù„Ù‚Ø© ØªÙƒØ±Ø§Ø±ÙŠØ© Ù„ÙÙƒ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªØ¯Ø§Ø®Ù„ (zip Ø¯Ø§Ø®Ù„ zip)
          ITER=0
          while true; do
            ITER=$((ITER+1))
            ZCOUNT=$(find _extract -type f -name "*.zip" | wc -l | tr -d ' ')
            if [ "$ZCOUNT" = "0" ]; then break; fi
            echo "ğŸ” Nested zip pass #$ITER (found $ZCOUNT zips)..."
            find _extract -type f -name "*.zip" -print0 | while IFS= read -r -d '' z; do
              DIR=$(dirname "$z")
              unzip -o -q "$z" -d "$DIR"
              rm -f "$z" || true
            done
          done
          echo "âœ… Extract done."

      # ---------------------------------------------------------
      # 2) ØªØ­Ø¯ÙŠØ¯ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      # ---------------------------------------------------------
      - name: 2) Locate PROJECT_ROOT
        shell: bash
        run: |
          set -euo pipefail
          MF=$(find _extract -type f -name "Makefile" | grep -E "/Tweak/Makefile$" | head -n 1 || true)
          if [ -z "${MF:-}" ]; then
            MF=$(find _extract -type f -name "Makefile" | head -n 1 || true)
          fi

          if [ -z "${MF:-}" ]; then
            echo "âŒ ERROR: Makefile not found."
            exit 1
          fi

          PROJECT_ROOT=$(dirname "$MF")
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> "$GITHUB_ENV"
          echo "âœ… PROJECT_ROOT = $PROJECT_ROOT"

      # ---------------------------------------------------------
      # 3) ØªØ«Ø¨ÙŠØª Theos
      # ---------------------------------------------------------
      - name: 3) Setup Theos
        shell: bash
        run: |
          rm -rf "$HOME/theos"
          git clone --recursive --depth=1 https://github.com/theos/theos.git "$HOME/theos"
          echo "THEOS=$HOME/theos" >> "$GITHUB_ENV"
          rm -rf "$HOME/theos/sdks"
          git clone --depth=1 https://github.com/theos/sdks.git "$HOME/theos/sdks"
          rm -rf "$HOME/theos/sdks/iPhoneOS"{9..13}.sdk || true
          brew install ldid xz fmt

      # ---------------------------------------------------------
      # 4) ØªØ¬Ù‡ÙŠØ² Ù…ÙƒØªØ¨Ø© KittyMemory
      # ---------------------------------------------------------
      - name: 4) Ensure KittyMemory
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"
          mkdir -p deps

          KITTY_HDR=$(find "$(cd ../.. && pwd)/_extract" -type f -name "KittyInclude.hpp" | head -n 1 || true)
          if [ -n "${KITTY_HDR:-}" ]; then
            SRC_DIR=$(dirname "$KITTY_HDR")
            BASE_DIR=$(dirname "$SRC_DIR")
            rm -rf deps/KittyMemory
            cp -R "$BASE_DIR" deps/KittyMemory
          else
            rm -rf deps/KittyMemory
            git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
          fi

          KI=$(find deps/KittyMemory -type f -name "KittyInclude.hpp" | head -n 1 || true)
          KITTY_INC_DIR=$(dirname "$KI")
          echo "KITTY_INC_DIR=$KITTY_INC_DIR" >> "$GITHUB_ENV"

      # ---------------------------------------------------------
      # 5) Ø¥ØµÙ„Ø§Ø­ Ù…ÙƒØªØ¨Ø© ZipArchive
      # ---------------------------------------------------------
      - name: 5) Ensure ZipArchive
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"
          mkdir -p deps
          if [ ! -d "deps/ZipArchive" ]; then
            git clone --depth=1 https://github.com/ZipArchive/ZipArchive.git deps/ZipArchive
          fi
          mkdir -p deps/SSZipArchive/SSZipArchive
          cat > deps/SSZipArchive/SSZipArchive/ZipArchive.h <<'EOF'
          #pragma once
          #import "ZipArchive.h"
          EOF

      # ---------------------------------------------------------
      # 6) Ø§Ù„Ø¨Ù†Ø§Ø¡ (ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø¨Ø¯ÙˆÙ† Ø¬Ù„Ø¨Ø±ÙŠÙƒ)
      # ---------------------------------------------------------
      - name: 6) Build (No Jailbreak Mode)
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          FMT_PREFIX="$(brew --prefix fmt)"
          INC_FLAGS="-I${{ env.KITTY_INC_DIR }} -I$FMT_PREFIX/include -I$PWD/deps/ZipArchive -I$PWD/deps/ZipArchive/ZipArchive -I$PWD/deps/SSZipArchive"
          LIB_FLAGS="-L$FMT_PREFIX/lib -lfmt"

          make clean || true

          # ØªÙ… Ø¥Ø²Ø§Ù„Ø© THEOS_PACKAGE_SCHEME=rootless Ù„Ø£Ù†Ù†Ø§ Ù†Ø±ÙŠØ¯ Ù…Ù„Ù dylib Ø¹Ø§Ø¯ÙŠ
          make package FINALPACKAGE=1 messages=yes \
            ADDITIONAL_CFLAGS="$INC_FLAGS" \
            ADDITIONAL_CCFLAGS="$INC_FLAGS -std=c++17" \
            ADDITIONAL_LDFLAGS="$LIB_FLAGS"

      # ---------------------------------------------------------
      # 7) Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙˆØ±ÙØ¹ Ù…Ù„Ù Dylib
      # ---------------------------------------------------------
      - name: 7) Extract & Upload Dylib
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"
          
          mkdir -p output_files
          
          echo "ğŸ“¦ Finding compiled files..."
          
          # 1. Ù†Ø³Ø® Ù…Ù„Ù DEB (Ø§Ø­ØªÙŠØ§Ø·ÙŠ)
          cp packages/*.deb output_files/ 2>/dev/null || true
          
          # 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù€ Dylib (Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ù‡Ù… Ù„Ù„Ø­Ù‚Ù†)
          # Ù†Ø¨Ø­Ø« Ø¹Ù†Ù‡ Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯Ø§Øª Theos Ø§Ù„Ù…Ø®ÙÙŠØ© (.theos/obj/debug Ø£Ùˆ .theos/obj)
          echo "ğŸ” Looking for .dylib file..."
          find .theos -name "*.dylib" -exec cp {} output_files/ \;
          
          echo "âœ… Files ready for upload:"
          ls -la output_files/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_NoJailbreak_Files
          path: ${{ env.PROJECT_ROOT }}/output_files/*
