name: Ultimate Zip Build (Auto scan + Auto Makefile)

on:
  push:
    branches: ["**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # 1) Extract ALL zip files (recursive) + show full paths
      # ------------------------------------------------------------
      - name: 1) Extract all zips (recursive) + show paths
        shell: bash
        run: |
          set -euo pipefail

          rm -rf _extract
          mkdir -p _extract

          echo "ðŸ”Ž Searching for zip files in repo root..."
          ls -la

          # ÙÙƒ Ø¶ØºØ· ÙƒÙ„ zips Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø¬Ø°Ø± Ø§Ù„Ø±ÙŠØ¨Ùˆ
          shopt -s nullglob
          for z in *.zip; do
            echo "ðŸ“¦ Unzipping: $z -> _extract/"
            unzip -o -q "$z" -d _extract
          done
          shopt -u nullglob

          # ÙÙƒ Ø¶ØºØ· Ø¨Ø´ÙƒÙ„ Ù…ØªÙƒØ±Ø± Ù„Ùˆ Ø¯Ø§Ø®Ù„ _extract ØªÙˆØ¬Ø¯ zips Ø«Ø§Ù†ÙŠØ©
          echo "ðŸ” Recursive unzip inside _extract (if any)..."
          for i in $(seq 1 6); do
            ZFOUND=$(find _extract -type f -name "*.zip" | head -n 1 || true)
            if [ -z "${ZFOUND:-}" ]; then
              echo "âœ… No more nested zips."
              break
            fi

            echo "âž¡ï¸ Pass $i: found nested zips, extracting..."
            while IFS= read -r zf; do
              [ -f "$zf" ] || continue
              zdir="$(dirname "$zf")"
              echo "   - unzip $zf -> $zdir"
              unzip -o -q "$zf" -d "$zdir"
              rm -f "$zf"
            done < <(find _extract -type f -name "*.zip")
          done

          echo "ðŸ§­ FULL TREE (depth 6):"
          find "$(pwd)/_extract" -maxdepth 6 -print

      # ------------------------------------------------------------
      # 2) Locate PROJECT_ROOT (Makefile preferred)
      # ------------------------------------------------------------
      - name: 2) Locate PROJECT_ROOT
        shell: bash
        run: |
          set -euo pipefail

          echo "ðŸ” Searching for Makefile..."
          MAKEFILE_PATH="$(find _extract -type f -name "Makefile" | head -n 1 || true)"

          if [ -n "${MAKEFILE_PATH:-}" ]; then
            PROJECT_ROOT="$(dirname "$MAKEFILE_PATH")"
            echo "âœ… Found Makefile at: $MAKEFILE_PATH"
          else
            echo "âš ï¸ Makefile not found. Searching for source files..."
            SRC_FILE="$(find _extract -type f \( -name "*.xm" -o -name "*.mm" -o -name "*.m" -o -name "*.cpp" -o -name "*.c" \) | head -n 1 || true)"
            if [ -z "${SRC_FILE:-}" ]; then
              echo "âŒ ERROR: No Makefile and no source files found in extracted content."
              exit 1
            fi
            # Ù†Ø®Ù„ÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù‡Ùˆ Ø£Ù‚Ø±Ø¨ Ù…Ø¬Ù„Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ debian/control Ø£Ùˆ layout Ù…Ø´Ø§Ø¨Ù‡ Ø£Ùˆ Ù…Ø¬Ø±Ø¯ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø³ÙˆØ±Ø³
            PROJECT_ROOT="$(dirname "$SRC_FILE")"
            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¯Ø§Ø®Ù„ src Ø±Ø¬Ø¹ Ø®Ø·ÙˆØ© Ù„Ù„Ø®Ù„Ù
            if [ "$(basename "$PROJECT_ROOT")" = "src" ]; then
              PROJECT_ROOT="$(dirname "$PROJECT_ROOT")"
            fi
            echo "âœ… Using source-based PROJECT_ROOT: $PROJECT_ROOT"
          fi

          echo "PROJECT_ROOT=$PROJECT_ROOT" >> "$GITHUB_ENV"
          echo "ðŸ“Œ PROJECT_ROOT (full): $(cd "$PROJECT_ROOT" && pwd)"

      # ------------------------------------------------------------
      # 3) Ensure KittyMemory exists (search inside + fallback clone)
      # ------------------------------------------------------------
      - name: 3) Ensure KittyMemory exists (search + fallback clone)
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          mkdir -p deps

          echo "ðŸ” Searching for KittyInclude.hpp in ALL extracted files..."
          KITTY_HEADER="$(find "$(cd .. && pwd)/.." -type f -name "KittyInclude.hpp" | head -n 1 || true)"

          if [ -n "${KITTY_HEADER:-}" ]; then
            echo "âœ… Found KittyInclude.hpp at: $KITTY_HEADER"
            # ØºØ§Ù„Ø¨Ø§Ù‹ ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³Ø§Ø± .../KittyMemory/KittyInclude.hpp Ø£Ùˆ .../KittyMemory/KittyMemory/KittyInclude.hpp
            KITTY_DIR="$(dirname "$KITTY_HEADER")"

            # Ø¥Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø¯Ø§Ø®Ù„ KittyMemory/KittyMemory/ Ø®Ø° Ø§Ù„Ø£Ø¨
            if [ "$(basename "$KITTY_DIR")" = "KittyMemory" ] && [ -d "$KITTY_DIR" ]; then
              # OK
              :
            else
              # Ø­Ø§ÙˆÙ„ ØªØ±Ø¬Ø¹ Ø®Ø·ÙˆØ© Ø¥Ø°Ø§ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø£Ø¨ KittyMemory
              if [ "$(basename "$(dirname "$KITTY_DIR")")" = "KittyMemory" ]; then
                KITTY_DIR="$(dirname "$KITTY_DIR")"
              fi
            fi

            echo "ðŸ“¦ Copy KittyMemory dir: $KITTY_DIR -> $PROJECT_ROOT/deps/KittyMemory"
            rm -rf "$PROJECT_ROOT/deps/KittyMemory"
            mkdir -p "$PROJECT_ROOT/deps/KittyMemory"
            cp -R "$KITTY_DIR"/. "$PROJECT_ROOT/deps/KittyMemory"/
          else
            echo "âš ï¸ KittyMemory not found inside zips. Cloning fallback..."
            rm -rf "$PROJECT_ROOT/deps/KittyMemory"
            git clone --depth=1 https://github.com/MJx0/KittyMemory.git "$PROJECT_ROOT/deps/KittyMemory"
          fi

          echo "ðŸ”Ž Verify KittyInclude.hpp final location:"
          find "$PROJECT_ROOT/deps/KittyMemory" -type f -name "KittyInclude.hpp" -maxdepth 6 -print || true

      # ------------------------------------------------------------
      # 4) Setup Theos clean + FIX sdks conflict + install fmt
      # ------------------------------------------------------------
      - name: 4) Setup Theos (clean) + SDKs + fmt
        shell: bash
        run: |
          set -euo pipefail

          rm -rf "$HOME/theos"
          git clone --recursive --depth=1 https://github.com/theos/theos.git "$HOME/theos"

          echo "THEOS=$HOME/theos" >> "$GITHUB_ENV"
          echo "$HOME/theos/bin" >> "$GITHUB_PATH"

          # FIX: sdks already exists
          rm -rf "$HOME/theos/sdks"
          git clone --depth=1 https://github.com/theos/sdks.git "$HOME/theos/sdks"

          # ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… sdk (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
          rm -rf "$HOME/theos/sdks/iPhoneOS"{9..13}".sdk" || true

          brew update
          brew install ldid xz fmt

          echo "âœ… Theos + SDKs + fmt ready."

      # ------------------------------------------------------------
      # 5) Auto-generate Makefile (solves missing file UEDumper.mm etc)
      # ------------------------------------------------------------
      - name: 5) Auto-Generate Makefile (uses existing files only)
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          echo "ðŸ§  Scanning project for sources..."
          echo "ðŸ“Œ Project full path: $(pwd)"

          echo "ðŸ§¾ Candidate sources (depth 6):"
          find . -maxdepth 6 -type f \( -name "*.xm" -o -name "*.mm" -o -name "*.m" -o -name "*.cpp" -o -name "*.c" \) -print

          # Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… tweak Ù…Ù† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
          TWEAK_NAME="UEDumper"

          # Ù…Ø³Ø§Ø±Ø§Øª KittyMemory include (Ù†Ø³ØªØ®Ø±Ø¬ Ù…ÙƒØ§Ù† KittyInclude.hpp)
          KITTY_INC_DIR="$(find deps/KittyMemory -type f -name "KittyInclude.hpp" -print | head -n 1 | xargs -I{} dirname "{}" || true)"
          if [ -z "${KITTY_INC_DIR:-}" ]; then
            # fallback
            KITTY_INC_DIR="deps/KittyMemory"
          fi

          # fmt paths
          FMT_PREFIX="$(brew --prefix fmt)"
          echo "FMT_PREFIX=$FMT_PREFIX"

          # Ø¥Ù†Ø´Ø§Ø¡ Makefile ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙØ¹Ù„Ø§Ù‹ (wildcards) ÙˆÙŠÙ…Ù†Ø¹ ØªÙˆÙ‚Ù Ø¨Ø³Ø¨Ø¨ Ù…Ù„Ù Ù…ÙÙ‚ÙˆØ¯
          rm -f Makefile
          cat > Makefile <<EOF
          TARGET := iphone:clang:latest:14.0
          ARCHS = arm64 arm64e
          THEOS_PACKAGE_SCHEME = rootless

          include \$(THEOS)/makefiles/common.mk

          TWEAK_NAME = ${TWEAK_NAME}

          # âœ… Build only what exists:
          ${TWEAK_NAME}_FILES = \\
            \$(wildcard *.xm) \$(wildcard *.mm) \$(wildcard *.m) \\
            \$(wildcard src/*.xm) \$(wildcard src/*.mm) \$(wildcard src/*.m) \\
            \$(wildcard src/*.cpp) \$(wildcard src/*.c) \\
            \$(wildcard src/*/*.mm) \$(wildcard src/*/*.m) \\
            \$(wildcard src/*/*.cpp) \$(wildcard src/*/*.c) \\
            \$(wildcard src/*/*/*.mm) \$(wildcard src/*/*/*.m) \\
            \$(wildcard src/*/*/*.cpp) \$(wildcard src/*/*/*.c)

          ${TWEAK_NAME}_FRAMEWORKS = UIKit Foundation Security

          # KittyMemory + fmt include/lib
          ${TWEAK_NAME}_CFLAGS += -fobjc-arc -Wno-error -Wno-deprecated-declarations -Wno-unused-variable
          ${TWEAK_NAME}_CCFLAGS += -std=c++17 -I. -Isrc -I${KITTY_INC_DIR} -Ideps/KittyMemory -I${FMT_PREFIX}/include
          ${TWEAK_NAME}_LDFLAGS += -L${FMT_PREFIX}/lib -lfmt

          include \$(THEOS_MAKE_PATH)/tweak.mk
          EOF

          echo "âœ… Makefile generated:"
          sed -n '1,200p' Makefile

      # ------------------------------------------------------------
      # 6) Build
      # ------------------------------------------------------------
      - name: 6) Build package
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          echo "ðŸš€ Building..."
          make clean || true
          make package FINALPACKAGE=1 messages=yes THEOS_PACKAGE_SCHEME=rootless

          echo "ðŸ“¦ Packages:"
          ls -la packages || true
          find packages -maxdepth 2 -type f -name "*.deb" -print || true

      - name: 7) Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: Build_DEB
          path: ${{ env.PROJECT_ROOT }}/packages/*.deb
