name: Ultimate Builder (Fix Source Detection)

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  build_fix:
    runs-on: macos-latest
    permissions:
      contents: write
      
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 1 Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©: Ø¨Ø­Ø« Ø´Ø§Ù…Ù„ Ø¹Ù† Ø£ÙŠ Ù†ÙˆØ¹ Ù…Ù„ÙØ§Øª ÙƒÙˆØ¯
      # ------------------------------------------------------------------
      - name: 2. Smart Unzip & Locate (Fixed)
        run: |
          # ÙÙƒ Ø¶ØºØ· Ø§Ù„Ù…Ù„Ù
          find . -name "*.zip" -exec unzip -o -q {} \;
          
          echo "ðŸ”Ž Searching for source code..."
          
          # Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† .xm OR .mm OR .cpp OR .c
          # Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ù‡Ù…Ø§ ÙƒØ§Ù†Øª Ù„ØºØ© Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©
          SOURCE_FILE=$(find . -type f \( -name "*.xm" -o -name "*.mm" -o -name "*.cpp" -o -name "*.c" \) | head -n 1)
          
          if [ -z "$SOURCE_FILE" ]; then
            echo "::error::Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ù„Ù ÙƒÙˆØ¯! Ø§Ù„Ù…Ø¬Ù„Ø¯ ÙŠØ¨Ø¯Ùˆ ÙØ§Ø±ØºØ§Ù‹ Ø£Ùˆ Ø§Ù„Ù…Ù„ÙØ§Øª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©."
            exit 1
          fi
          
          PROJECT_DIR=$(dirname "$SOURCE_FILE")
          echo "âœ… Project found in: $PROJECT_DIR"
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV

      # ------------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Keystone)
      # ------------------------------------------------------------------
      - name: 3. Install Dependencies
        run: |
          cd ${{ env.PROJECT_DIR }}
          mkdir -p deps
          rm -rf deps/KittyMemory deps/fmt deps/keystone
          
          git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
          git clone --depth=1 https://github.com/fmtlib/fmt.git deps/fmt
          git clone --depth=1 https://github.com/keystone-engine/keystone.git deps/keystone

      # ------------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Makefile Ø§Ù„Ø¬Ø¯ÙŠØ¯
      # ------------------------------------------------------------------
      - name: 4. Generate Makefile
        run: |
          cd ${{ env.PROJECT_DIR }}
          rm -f Makefile
          
          cat > Makefile <<EOF
          TARGET := iphone:clang:latest:14.0
          ARCHS = arm64
          include \$(THEOS)/makefiles/common.mk

          TWEAK_NAME = UEDumper

          # Ù†Ø¬Ù…Ø¹ ÙƒÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª
          UEDumper_FILES = \$(wildcard *.xm) \$(wildcard *.mm) \$(wildcard *.cpp) \$(wildcard src/*.cpp) \$(wildcard src/*.mm) \$(wildcard src/*.c)
          
          # Ø±Ø¨Ø· Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
          UEDumper_CCFLAGS = -std=c++17 \
            -I"deps/KittyMemory" \
            -I"deps/fmt/include" \
            -I"deps/keystone/include" \
            -DFMT_HEADER_ONLY \
            -Wno-unused-variable

          UEDumper_CFLAGS = -I"deps/KittyMemory" -I"deps/fmt/include" -I"deps/keystone/include"
          
          include \$(THEOS_MAKE_PATH)/tweak.mk
          EOF

      # ------------------------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø¥Ø¹Ø¯Ø§Ø¯ Theos ÙˆØ§Ù„Ø¨Ù†Ø§Ø¡
      # ------------------------------------------------------------------
      - name: 5. Build & Export
        uses: actions/checkout@v4
        with:
          repository: theos/theos
          path: theos
          ref: master

      - name: 6. Run Build
        run: |
          export THEOS=$(pwd)/theos
          cd ${{ env.PROJECT_DIR }}
          
          make clean
          make package FINALPACKAGE=1 messages=yes
          
          mkdir -p ../FINAL
          find .theos -name "*.dylib" -exec cp {} ../FINAL/UEDumper_Injection.dylib \;
          cp packages/*.deb ../FINAL/ 2>/dev/null || true
          
      - name: 7. Upload
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_Fixed
          path: FINAL/*
