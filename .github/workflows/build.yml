name: Force Build (Auto-Rewrite Makefile)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. ÙÙƒ Ø§Ù„Ø¶ØºØ· ÙˆØ§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù† Ø§Ù„ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      - name: Unzip and Find Source
        run: |
          # ÙÙƒ Ø§Ù„Ø¶ØºØ· Ø¹Ù† Ø£ÙŠ Ù…Ù„Ù zip Ù…ÙˆØ¬ÙˆØ¯
          unzip -o -q *.zip
          
          # Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù…Ù„Ù ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ .xm Ù„Ù†Ø¹Ø±Ù Ø£ÙŠÙ† ÙŠÙˆØ¬Ø¯ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
          # Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ø³ÙŠØ¬Ø¯ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­ 100% Ù…Ù‡Ù…Ø§ ÙƒØ§Ù† Ø§Ù„Ø§Ø³Ù…
          SOURCE_FILE=$(find . -name "*.xm" | head -n 1)
          
          if [ -z "$SOURCE_FILE" ]; then
            echo "ERROR: No source code (.xm file) found inside the zip!"
            exit 1
          fi
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù
          PROJECT_DIR=$(dirname "$SOURCE_FILE")
          echo "âœ… Found source code in: $PROJECT_DIR"
          
          # Ø­ÙØ¸ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV

      # 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
      - name: Force Install Dependencies
        run: |
          cd ${{ env.PROJECT_DIR }}
          mkdir -p deps
          
          echo "â¬‡ï¸ Downloading dependencies..."
          rm -rf deps/KittyMemory deps/fmt
          
          git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
          git clone --depth=1 https://github.com/fmtlib/fmt.git deps/fmt

      # 3. ÙƒØªØ§Ø¨Ø© Ù…Ù„Ù Makefile Ø¬Ø¯ÙŠØ¯ (Ù‡Ù†Ø§ Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø°Ø±ÙŠ)
      - name: Generate Fresh Makefile
        run: |
          cd ${{ env.PROJECT_DIR }}
          
          echo "â™»ï¸ Deleting old Makefile..."
          rm -f Makefile
          
          echo "ðŸ“ Writing NEW Makefile..."
          # Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù makefile Ø¨Ø³ÙŠØ· ÙˆÙ…Ø¨Ø§Ø´Ø± ÙŠØ¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª
          cat > Makefile <<EOF
          TARGET := iphone:clang:latest:14.0
          ARCHS = arm64
          
          include \$(THEOS)/makefiles/common.mk

          TWEAK_NAME = UEDumper

          # Ø¬Ù…Ø¹ ÙƒÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø³ÙˆØ±Ø³ (xm, mm, cpp) ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          UEDumper_FILES = \$(wildcard *.xm) \$(wildcard *.mm) \$(wildcard *.cpp) \$(wildcard src/*.cpp) \$(wildcard src/*.mm)
          
          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª (KittyMemory + fmt)
          UEDumper_CCFLAGS = -std=c++17 -I"deps/KittyMemory" -I"deps/fmt/include" -DFMT_HEADER_ONLY
          UEDumper_CFLAGS = -I"deps/KittyMemory" -I"deps/fmt/include"
          
          include \$(THEOS_MAKE_PATH)/tweak.mk
          EOF
          
          echo "âœ… New Makefile created:"
          cat Makefile

      # 4. ØªØ«Ø¨ÙŠØª Theos
      - name: Setup Theos
        uses: actions/checkout@v4
        with:
          repository: theos/theos
          path: theos
          ref: master

      # 5. Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Dylib (Ù„Ù„Ø¨Ø¯ÙˆÙ† Ø¬Ù„Ø¨Ø±ÙŠÙƒ)
      - name: Build & Extract Dylib
        run: |
          export THEOS=$(pwd)/theos
          cd ${{ env.PROJECT_DIR }}
          
          echo "ðŸš€ Building..."
          make clean
          # Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ Ø³ØªØ¸Ù‡Ø± Ø¨ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¢Ù† Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
          make package FINALPACKAGE=1 messages=yes
          
          # ØªØ¬Ù‡ÙŠØ² Ù…Ø¬Ù„Ø¯ Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø§ØªØ¬Ø©
          mkdir -p ../output
          
          echo "ðŸ”Ž Hunting for the .dylib file..."
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù dylib Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯Ø§Øª theos Ø§Ù„Ù…Ø®ÙÙŠØ© ÙˆÙ†Ø³Ø®Ù‡
          find .theos -name "*.dylib" -exec cp {} ../output/UEDumper_NoJailbreak.dylib \;
          
          # Ù†Ø³Ø® Ù…Ù„Ù DEB Ø£ÙŠØ¶Ø§Ù‹ ÙƒØ§Ø­ØªÙŠØ§Ø·
          cp packages/*.deb ../output/ 2>/dev/null || true
          
          echo "âœ… Files ready in output folder."

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_NoJailbreak_File
          path: output/*
