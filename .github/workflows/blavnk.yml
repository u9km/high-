name: Ultimate Builder (Auto-Fix & No Jailbreak)

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  build_solution:
    runs-on: macos-latest
    permissions:
      contents: write
      
    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------------------
      # Ø®Ø·ÙˆØ© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ: ØªØ¬Ø¯ Ø§Ù„ÙƒÙˆØ¯ ÙˆØªØ­Ø¯Ø¯ Ù…ÙƒØ§Ù†Ù‡ ÙˆØªÙÙƒ Ø§Ù„Ø¶ØºØ·
      # ---------------------------------------------------------
      - name: 2. Smart Unzip & Locate
        run: |
          # ÙÙƒ Ø¶ØºØ· Ø£ÙŠ Ù…Ù„Ù zip Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
          find . -name "*.zip" -exec unzip -o -q {} \;
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù Tweak.xm Ø£Ùˆ Ø£ÙŠ Ù…Ù„Ù .xm Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
          SOURCE_FILE=$(find . -name "*.xm" | head -n 1)
          
          if [ -z "$SOURCE_FILE" ]; then
            echo "::error::Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ù„Ù ÙƒÙˆØ¯ (.xm)! ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª."
            exit 1
          fi
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø¬Ù„Ø¯
          PROJECT_DIR=$(dirname "$SOURCE_FILE")
          echo "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙÙŠ: $PROJECT_DIR"
          
          # Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV

      # ---------------------------------------------------------
      # Ø®Ø·ÙˆØ© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª: ØªØ¬Ø¨Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù„Ù‰ ØªØ­Ù…ÙŠÙ„Ù‡Ø§
      # ---------------------------------------------------------
      - name: 3. Force Install Dependencies
        run: |
          cd ${{ env.PROJECT_DIR }}
          mkdir -p deps
          
          echo "â¬‡ï¸ Downloading clean dependencies..."
          rm -rf deps/KittyMemory deps/fmt
          
          git clone --depth=1 https://github.com/MJx0/KittyMemory.git deps/KittyMemory
          git clone --depth=1 https://github.com/fmtlib/fmt.git deps/fmt

      # ---------------------------------------------------------
      # Ø®Ø·ÙˆØ© "Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø°Ø±ÙŠ": Ø­Ø°Ù Ø§Ù„Ù€ Makefile Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆÙƒØªØ§Ø¨Ø© ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯
      # ---------------------------------------------------------
      - name: 4. Generate Fresh Makefile
        run: |
          cd ${{ env.PROJECT_DIR }}
          
          echo "â™»ï¸ Removing old Makefile..."
          rm -f Makefile
          
          echo "ğŸ“ Writing NEW clean Makefile..."
          # Ù†ÙƒØªØ¨ Ù…Ù„Ù Makefile Ù‚ÙŠØ§Ø³ÙŠ ÙŠØ¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆÙŠØ¬Ù‡Ø²Ù‡Ø§ Ù„Ù„Ø­Ù‚Ù†
          cat > Makefile <<EOF
          TARGET := iphone:clang:latest:14.0
          ARCHS = arm64
          include \$(THEOS)/makefiles/common.mk

          TWEAK_NAME = UEDumper

          # ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø³ÙˆØ±Ø³ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (xm, mm, cpp)
          UEDumper_FILES = \$(wildcard *.xm) \$(wildcard *.mm) \$(wildcard *.cpp) \$(wildcard src/*.cpp) \$(wildcard src/*.mm)
          
          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª ÙˆØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
          UEDumper_CCFLAGS = -std=c++17 -I"deps/KittyMemory" -I"deps/fmt/include" -DFMT_HEADER_ONLY
          UEDumper_CFLAGS = -I"deps/KittyMemory" -I"deps/fmt/include"
          
          include \$(THEOS_MAKE_PATH)/tweak.mk
          EOF
          
          echo "âœ… New Makefile created successfully."

      # ---------------------------------------------------------
      # Ø®Ø·ÙˆØ© Ø¥Ø¹Ø¯Ø§Ø¯ Theos
      # ---------------------------------------------------------
      - name: 5. Setup Theos
        uses: actions/checkout@v4
        with:
          repository: theos/theos
          path: theos
          ref: master

      # ---------------------------------------------------------
      # Ø®Ø·ÙˆØ© Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Dylib (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø¯ÙˆÙ† Ø¬Ù„Ø¨Ø±ÙŠÙƒ)
      # ---------------------------------------------------------
      - name: 6. Build & Extract Dylib
        run: |
          export THEOS=$(pwd)/theos
          cd ${{ env.PROJECT_DIR }}
          
          echo "ğŸš€ Building Project..."
          make clean
          make package FINALPACKAGE=1 messages=yes
          
          # ØªØ¬Ù‡ÙŠØ² Ù…Ø¬Ù„Ø¯ Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
          mkdir -p ../FINAL_OUTPUT
          
          echo "ğŸ” Looking for Dylib file (for injection)..."
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù dylib Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯Ø§Øª theos Ø§Ù„Ù…Ø®ÙÙŠØ© ÙˆÙ†Ø³Ø®Ù‡
          find .theos -name "*.dylib" -exec cp {} ../FINAL_OUTPUT/UEDumper_Injection.dylib \;
          
          # Ù†Ø³Ø® Ù…Ù„Ù DEB Ø£ÙŠØ¶Ø§Ù‹
          cp packages/*.deb ../FINAL_OUTPUT/ 2>/dev/null || true
          
          echo "âœ… Files ready."
          ls -la ../FINAL_OUTPUT/

      # ---------------------------------------------------------
      # Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ùƒ
      # ---------------------------------------------------------
      - name: 7. Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: UEDumper_Files_NoJailbreak
          path: FINAL_OUTPUT/*
